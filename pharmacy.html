<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pharmacy Dashboard — PHARMA DIRECT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css" />
</head>

<body class="min-h-screen bg-gray-50">
    <div class="grid md:grid-cols-[260px_1fr] min-h-screen">
        <aside class="bg-white border-r border-gray-200 shadow-sm">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-emerald-500 to-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Pharmacy Panel</h1>
                        <p class="text-sm text-gray-500">Business Management</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="p-4 space-y-2">
                <button data-tab="products" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl bg-gradient-to-r from-emerald-500 to-blue-600 text-white shadow-sm transition-all duration-200 hover:shadow-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <span class="font-medium">Products</span>
                </button>
                
                <button data-tab="orders" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200 hover:shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    <span class="font-medium">Orders</span>
                </button>
                
                <button data-tab="wallet" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200 hover:shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                    <span class="font-medium">Wallet</span>
                </button>
            </nav>

            <!-- Logout Section -->
            <div class="p-4 border-t border-gray-200 mt-auto">
                <button id="logout" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl text-red-600 hover:bg-red-50 transition-all duration-200 hover:shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </aside>
        <main class="p-4">
            <div id="tab-products" class="space-y-6">
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-xl p-6 text-white">
                    <h1 class="text-2xl font-bold">Product Management</h1>
                    <p class="text-emerald-100 mt-1">Add and manage your pharmacy products</p>
                </div>
                <form id="product-form" class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Left Column -->
                        <div class="space-y-5">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Basic Information
                                </h3>
                    <div class="space-y-4">
                        <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Product Name *</label>
                                        <input name="name" required class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                                placeholder="Enter product name" />
                        </div>
                            <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                                        <select name="category" class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                                <option value="">Select Category</option>
                                <option value="Pain Relief">Pain Relief</option>
                                <option value="Cold & Flu">Cold & Flu</option>
                                <option value="Digestive Health">Digestive Health</option>
                                <option value="Vitamins & Supplements">Vitamins & Supplements</option>
                                <option value="First Aid">First Aid</option>
                                <option value="Personal Care">Personal Care</option>
                                <option value="Baby Care">Baby Care</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                        <textarea name="description" class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" rows="3"
                                            placeholder="Product description..."></textarea>
                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div class="space-y-5">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                    Pricing & Inventory
                                </h3>
                    <div class="space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Price (₱) *</label>
                                            <input name="price" type="number" min="0" step="0.01" required
                                                class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="0.00" />
                        </div>
                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Discount (%)</label>
                                            <input name="discount" type="number" min="0" max="100" step="1"
                                                class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="0" />
                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Stock Quantity *</label>
                                        <input name="stock" type="number" min="0" required
                                            class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="0" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
                                        <input name="imageURL" class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                                            placeholder="https://example.com/image.jpg" />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Product Settings
                                </h3>
                                <div class="space-y-3">
                                    <label class="inline-flex items-center gap-3 text-sm font-medium text-gray-700">
                                        <input name="featured" type="checkbox" class="w-4 h-4 text-emerald-600 bg-gray-100 border-gray-300 rounded focus:ring-emerald-500 focus:ring-2" />
                                        <span>Featured Product</span>
                            </label>
                                    <label class="inline-flex items-center gap-3 text-sm font-medium text-gray-700">
                                        <input name="prescription" type="checkbox" class="w-4 h-4 text-emerald-600 bg-gray-100 border-gray-300 rounded focus:ring-emerald-500 focus:ring-2" />
                                        <span>Requires Prescription</span>
                            </label>
                        </div>
                    </div>
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t border-gray-200 flex justify-end space-x-4">
                        <button type="button" id="cancel-edit"
                            class="px-6 py-3 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors font-medium hidden">
                            Cancel
                        </button>
                        <button type="submit"
                            class="px-8 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            <span id="submit-text">Add Product</span>
                        </button>
                    </div>
                </form>
                <div id="products-list" class="bg-white rounded-xl border"></div>
            </div>
            <div id="tab-orders" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">Orders</h2>
                </div>

                <!-- Order Status Tabs -->
                <div class="bg-white rounded-xl border mb-6">
                    <div class="border-b">
                        <nav class="flex" id="order-status-tabs">
                            <button id="tab-all"
                                class="pharmacy-tab-button active flex-1 py-4 px-6 text-center border-b-2 border-emerald-500 text-emerald-600 font-medium relative">
                                All Orders
                                <span
                                    class="pharmacy-order-count-badge absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-pending"
                                class="pharmacy-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative">
                                Pending
                                <span
                                    class="pharmacy-order-count-badge absolute -top-2 -right-2 bg-yellow-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-confirmed"
                                class="pharmacy-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative">
                                Confirmed
                                <span
                                    class="pharmacy-order-count-badge absolute -top-2 -right-2 bg-blue-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-to-be-received"
                                class="pharmacy-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative">
                                To Be Received
                                <span
                                    class="pharmacy-order-count-badge absolute -top-2 -right-2 bg-purple-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-delivered"
                                class="pharmacy-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative">
                                Delivered
                                <span
                                    class="pharmacy-order-count-badge absolute -top-2 -right-2 bg-green-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-declined"
                                class="pharmacy-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative">
                                Declined
                                <span
                                    class="pharmacy-order-count-badge absolute -top-2 -right-2 bg-gray-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                                    style="display: none;">0</span>
                            </button>
                        </nav>
                    </div>
                </div>

                <div id="orders-list" class="bg-white rounded-xl border"></div>
            </div>

            <!-- Wallet Tab -->
            <div id="tab-wallet" class="hidden space-y-6">
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-xl p-6 text-white">
                    <h2 class="text-2xl font-bold">Wallet Management</h2>
                    <p class="text-emerald-100 mt-1">Manage your earnings and withdrawal requests</p>
                </div>

                <!-- Wallet Balance Cards -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-14 h-14 bg-emerald-100 rounded-full flex items-center justify-center">
                                <svg class="w-7 h-7 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Available Balance</h3>
                                <p class="text-sm text-gray-600">Ready for withdrawal</p>
                            </div>
                        </div>
                        <div class="text-4xl font-bold text-emerald-600" id="wallet-balance">₱0.00</div>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Pending Balance</h3>
                                <p class="text-sm text-gray-600">Awaiting confirmation</p>
                            </div>
                        </div>
                        <div class="text-4xl font-bold text-blue-600" id="pending-balance">₱0.00</div>
                    </div>
                </div>

                <!-- Withdrawal Section -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Withdrawal Request</h3>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Amount Section -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Amount to Withdraw *</label>
                            <input type="number" id="withdrawal-amount" min="100" step="0.01"
                                class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="0.00" />
                            <p class="text-sm text-gray-500 mt-2">Minimum withdrawal: ₱100.00</p>
                        </div>

                        <!-- Payment Method Section -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Payment Method *</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="payment-method" value="gcash" class="sr-only peer" />
                                    <div class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-colors">
                                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                            <span class="text-green-600 font-bold text-sm">G</span>
                                        </div>
                                        <span class="font-medium text-gray-700">GCash</span>
                                    </div>
                                </label>
                                
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="payment-method" value="maya" class="sr-only peer" />
                                    <div class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-colors">
                                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                            <span class="text-purple-600 font-bold text-sm">M</span>
                                        </div>
                                        <span class="font-medium text-gray-700">Maya</span>
                                    </div>
                                </label>
                                
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="payment-method" value="bank" class="sr-only peer" />
                                    <div class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-colors">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                            </svg>
                                        </div>
                                        <span class="font-medium text-gray-700">Bank Transfer</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Account Details Section -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Account Details</h4>
                            
                            <!-- GCash/Maya Details -->
                            <div id="digital-wallet-details" class="hidden space-y-4">
                        <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number *</label>
                                    <input type="tel" id="mobile-number" placeholder="09XX XXX XXXX"
                                        class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Name *</label>
                                    <input type="text" id="account-name" placeholder="Full Name"
                                        class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" />
                                </div>
                            </div>

                            <!-- Bank Details -->
                            <div id="bank-details" class="hidden space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Bank Name *</label>
                                        <select id="bank-name" class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                                            <option value="">Select Bank</option>
                                            <option value="BDO">BDO (Banco de Oro)</option>
                                            <option value="BPI">BPI (Bank of the Philippine Islands)</option>
                                            <option value="Metrobank">Metrobank</option>
                                            <option value="Landbank">Landbank</option>
                                            <option value="PNB">PNB (Philippine National Bank)</option>
                                            <option value="Security Bank">Security Bank</option>
                                            <option value="Union Bank">Union Bank</option>
                                            <option value="RCBC">RCBC</option>
                                            <option value="EastWest Bank">EastWest Bank</option>
                                            <option value="Chinabank">Chinabank</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Number *</label>
                                <input type="text" id="account-number" placeholder="Account Number"
                                            class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" />
                            </div>
                        </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Name *</label>
                                    <input type="text" id="bank-account-name" placeholder="Full Name as it appears on bank account"
                                        class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" />
                                </div>
                            </div>
                        </div>

                        <button id="request-withdrawal"
                            class="w-full bg-emerald-600 text-white py-4 px-6 rounded-lg font-semibold hover:bg-emerald-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                            Request Withdrawal
                        </button>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Recent Transactions</h3>
                    </div>
                    <div id="transactions-list" class="space-y-3">
                        <!-- Transactions will be loaded here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, doc, getDoc, orderBy, limit, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { firebaseConfig, COLLECTIONS, formatCurrency, safeDateConversion, formatDate, formatRelativeTime, showError, showSuccess, getProfessionalErrorMessage, setButtonLoading, showLoadingModal, hideLoadingModal } from './js/firebase.js';
        import { logout } from './js/auth.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const tabs = document.querySelectorAll('aside [data-tab]');
        const panels = {
            products: document.getElementById('tab-products'),
            orders: document.getElementById('tab-orders'),
            wallet: document.getElementById('tab-wallet'),
        };
        tabs.forEach(btn => btn.addEventListener('click', async () => {
            // Remove active styling from all tabs
            tabs.forEach(b => {
                b.classList.remove('bg-gradient-to-r', 'from-emerald-500', 'to-blue-600', 'text-white', 'shadow-sm');
                b.classList.add('text-gray-700');
            });
            
            // Add active styling to clicked tab
            btn.classList.remove('text-gray-700');
            btn.classList.add('bg-gradient-to-r', 'from-emerald-500', 'to-blue-600', 'text-white', 'shadow-sm');
            
            // Show/hide panels
            Object.values(panels).forEach(p => p.classList.add('hidden'));
            panels[btn.dataset.tab].classList.remove('hidden');

            // Load wallet data when wallet tab is selected
            if (btn.dataset.tab === 'wallet') {
                await loadWalletData();
                setupPaymentMethodHandlers();
            }
        }));

        let pharmacyId = null;

        async function ensurePharmacy(user) {
            const userDoc = await getDoc(doc(db, COLLECTIONS.users, user.uid));
            if (!userDoc.exists() || userDoc.data().role !== 'pharmacy') {
                window.location.href = 'index.html';
                return;
            }
            if (userDoc.data().disabled) {
                window.location.href = 'disabled.html';
                return;
            }
            // Use user uid as pharmacyId for simplicity
            pharmacyId = user.uid;
        }

        let editingProductId = null;

        async function loadProducts() {
            const qRef = query(collection(db, COLLECTIONS.products), where('pharmacyId', '==', pharmacyId));
            const snap = await getDocs(qRef);
            const el = document.getElementById('products-list');

            if (snap.empty) {
                el.innerHTML = `
                    <div class="p-8 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No products</h3>
                        <p class="mt-1 text-sm text-gray-500">Get started by adding your first product.</p>
                    </div>
                `;
                return;
            }

            el.innerHTML = `
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-t-xl p-6 text-white">
                    <h3 class="text-xl font-bold">Your Products</h3>
                    <p class="text-emerald-100 mt-1">${snap.docs.length} product${snap.docs.length !== 1 ? 's' : ''} in your inventory</p>
                </div>
                <div class="p-6 space-y-4 bg-gray-50">
                    ${Array.from(snap.docs).map(d => {
                const p = d.data();
                const isOutOfStock = p.stock === 0;
                const discountPrice = p.discount > 0 ? (p.price * (1 - p.discount / 100)).toFixed(2) : null;
                
                return `
                            <div class="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-lg transition-shadow duration-200 ${isOutOfStock ? 'opacity-75' : ''}">
                                <div class="flex items-start justify-between">
                                    <!-- Product Image & Info -->
                                    <div class="flex items-start gap-4 flex-1">
                                        <div class="relative">
                                        <img src="${p.imageURL || 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=100&auto=format&fit=crop'}" 
                                                 class="w-20 h-20 rounded-lg border object-cover" />
                                            ${isOutOfStock ? `
                                                <div class="absolute inset-0 bg-red-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                                                    <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full font-medium">Sold Out</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        <div class="flex-1">
                                            <div class="flex items-start justify-between mb-2">
                                                <div>
                                                    <h4 class="text-lg font-semibold text-gray-900 mb-1">${p.name}</h4>
                                                    <p class="text-sm text-gray-600">${p.category || 'Uncategorized'}</p>
                                            </div>
                                                
                                                <!-- Status Badges -->
                                                <div class="flex flex-wrap gap-1">
                                                    ${p.featured ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Featured</span>' : ''}
                                                    ${p.prescription ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Prescription</span>' : ''}
                                                </div>
                                            </div>
                                            
                                            ${p.description ? `<p class="text-sm text-gray-600 mb-3 line-clamp-2">${p.description}</p>` : ''}
                                            
                                            <!-- Pricing & Stock -->
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-3">
                                                    ${discountPrice ? `
                                                    <div class="flex items-center gap-2">
                                                            <span class="text-xl font-bold text-emerald-600">₱${discountPrice}</span>
                                                        <span class="text-sm text-gray-500 line-through">₱${p.price.toFixed(2)}</span>
                                                            <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-medium">${p.discount}% OFF</span>
                                                    </div>
                                                ` : `
                                                        <span class="text-xl font-bold text-emerald-600">₱${p.price.toFixed(2)}</span>
                                                `}
                                            </div>
                                                
                                                <div class="flex items-center gap-4">
                                                    <div class="text-right">
                                                        <div class="text-sm text-gray-500">Stock</div>
                                                        <div class="text-lg font-semibold ${isOutOfStock ? 'text-red-600' : 'text-gray-900'}">${p.stock}</div>
                                        </div>
                                    </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="flex flex-col gap-2 ml-4">
                                        <button onclick="editProduct('${d.id}')" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                            Edit
                                        </button>
                                        <button onclick="deleteProduct('${d.id}')" class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        let currentOrderStatus = 'all';
        let allOrders = [];
        let orderCounts = { all: 0, pending: 0, confirmed: 0, 'to-be-received': 0, delivered: 0, declined: 0 };

        function updateOrderCounts() {
            // Reset counts
            orderCounts = { all: 0, pending: 0, confirmed: 0, 'to-be-received': 0, delivered: 0, declined: 0 };

            // Count orders by status (only orders containing pharmacy's products)
            allOrders.forEach(({ order }) => {
                const status = order.stage.toLowerCase().replace(/\s+/g, '-');
                if (status in orderCounts) {
                    orderCounts[status]++;
                }
                orderCounts.all++;
            });

            // Update tab badges (simple approach like user track.html)
            document.querySelectorAll('.pharmacy-tab-button').forEach(tab => {
                const tabId = tab.id.replace('tab-', '');
                const badge = tab.querySelector('.pharmacy-order-count-badge');

                if (badge) {
                    const count = orderCounts[tabId] || 0;
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'inline-flex' : 'none';
                }
            });

            console.log('Pharmacy order counts:', orderCounts);
        }

        function renderFilteredOrders() {
            const filteredOrders = currentOrderStatus === 'all'
                ? allOrders
                : allOrders.filter(({ order }) => {
                    const stage = order.stage.toLowerCase().replace(/\s+/g, '-');
                    // Handle special case for declined tab (matches both 'declined' and 'cancelled')
                    if (currentOrderStatus === 'declined') {
                        return stage === 'declined' || stage === 'cancelled';
                    }
                    return stage === currentOrderStatus;
                });

            const el = document.getElementById('orders-list');
            el.innerHTML = '';

            if (filteredOrders.length === 0) {
                el.innerHTML = `
                    <div class="p-8 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No orders</h3>
                        <p class="mt-1 text-sm text-gray-500">Orders will appear here when customers place them.</p>
                    </div>
                `;
                return;
            }

            el.innerHTML = `
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-t-xl p-6 text-white">
                    <h3 class="text-xl font-bold">Recent Orders</h3>
                    <p class="text-emerald-100 mt-1">${filteredOrders.length} order${filteredOrders.length !== 1 ? 's' : ''} found</p>
                </div>
                <div class="p-6 space-y-6 bg-gray-50">
                    ${filteredOrders.map(({ doc, order }) => {
                const o = order;

                // Handle Firestore Timestamp objects properly
                const orderDate = safeDateConversion(o.createdAt).toLocaleString();

                const items = o.items.map(i => `${i.name} x${i.quantity}`).join(', ');

                // Handle new customer info structure
                const customerName = o.customerInfo ? o.customerInfo.name : (o.userName || 'Unknown');
                const customerPhone = o.customerInfo ? o.customerInfo.phone : 'Not provided';
                const customerEmail = o.customerInfo ? o.customerInfo.email : 'Not provided';

                return `
                            <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-shadow duration-200">
                                <!-- Order Header -->
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="text-xl font-bold text-gray-900">Order #${doc.id.slice(-6)}</h4>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStageColor(o.stage)}">
                                                ${o.stage}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-500">Order Date</div>
                                        <div class="text-sm font-medium text-gray-900">${orderDate}</div>
                                    </div>
                                </div>

                                <!-- Order Content -->
                                <div class="grid md:grid-cols-2 gap-6 mb-4">
                                    <!-- Left Column: Items & Payment -->
                                    <div class="space-y-4">
                                        <div>
                                            <h5 class="font-medium text-gray-900 mb-2">Items Ordered</h5>
                                            <div class="bg-gray-50 rounded-lg p-3">
                                                <p class="text-sm text-gray-700">${items}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="bg-blue-50 rounded-lg p-3">
                                                <p class="text-xs font-medium text-blue-600 uppercase tracking-wide">Total Amount</p>
                                                <p class="text-lg font-semibold text-blue-900">₱${o.total.toFixed(2)}</p>
                                            </div>
                                            <div class="bg-green-50 rounded-lg p-3">
                                                <p class="text-xs font-medium text-green-600 uppercase tracking-wide">Payment</p>
                                                <p class="text-sm font-semibold text-green-900">${o.paymentMethod}</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column: Customer & Delivery -->
                                    <div class="space-y-4">
                                        <div>
                                            <h5 class="font-medium text-gray-900 mb-2">Customer Information</h5>
                                            <div class="bg-gray-50 rounded-lg p-3 space-y-1">
                                                <p class="text-sm"><span class="font-medium">Name:</span> ${customerName}</p>
                                                ${customerPhone !== 'Not provided' ? `<p class="text-sm"><span class="font-medium">Phone:</span> ${customerPhone}</p>` : ''}
                                                ${customerEmail !== 'Not provided' ? `<p class="text-sm"><span class="font-medium">Email:</span> ${customerEmail}</p>` : ''}
                                            </div>
                                        </div>
                                        
                                        ${o.deliveryAddress ? `
                                        <div>
                                            <h5 class="font-medium text-gray-900 mb-2">Delivery Address</h5>
                                            <div class="bg-gray-50 rounded-lg p-3">
                                                <p class="text-sm text-gray-700">${o.deliveryAddress}</p>
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex flex-wrap gap-2 pt-4 border-t border-gray-200">
                                    <button onclick="viewOrderDetails('${doc.id}')" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        View Details
                                    </button>
                                        ${o.stage === 'Pending' ? `
                                        <button onclick="confirmOrder('${doc.id}')" class="flex items-center gap-2 px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm font-medium hover:bg-emerald-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                                Confirm & Deduct Stock
                                            </button>
                                        <button onclick="declineOrder('${doc.id}')" class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                                Decline Order
                                            </button>
                                        ` : ''}
                                        ${getNextActionText(o.stage) ? `
                                        <button onclick="advanceOrder('${doc.id}')" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                            </svg>
                                                ${getNextActionText(o.stage)}
                                            </button>
                                        ` : ''}
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        function loadOrders(status = 'all') {
            currentOrderStatus = status;

            // Update tab styling
            document.querySelectorAll('.pharmacy-tab-button').forEach(tab => {
                if (tab.id === `tab-${status}`) {
                    tab.classList.add('active', 'border-emerald-500', 'text-emerald-600');
                    tab.classList.remove('border-transparent', 'text-gray-500');
                } else {
                    tab.classList.remove('active', 'border-emerald-500', 'text-emerald-600');
                    tab.classList.add('border-transparent', 'text-gray-500');
                }
            });

            // Render filtered orders (client-side filtering)
            renderFilteredOrders();
        }

        // Load all orders and set up real-time updates
        function loadAllOrders() {
            // Show initial loading state
            const el = document.getElementById('orders-list');
            el.innerHTML = `
                <div class="flex items-center justify-center p-12">
                    <div class="text-center">
                        <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-emerald-500 hover:bg-emerald-400 transition ease-in-out duration-150 cursor-not-allowed">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading orders...
                        </div>
                    </div>
                </div>
            `;

            const ordersQuery = query(collection(db, COLLECTIONS.orders), orderBy('createdAt', 'desc'));

            onSnapshot(ordersQuery, async (snap) => {
                allOrders = [];

                // Process all orders and filter for pharmacy's products
                for (const doc of snap.docs) {
                    const order = doc.data();

                    // Check if this pharmacy owns any products in this order
                    const ownsItems = await pharmacyOwnsOrderItems(order);
                    if (ownsItems) {
                        allOrders.push({ doc, order });
                    }
                }

                // Update counts and render
                updateOrderCounts();
                renderFilteredOrders();
            });
        }

        // Helper function to check if pharmacy owns products in the order
        async function pharmacyOwnsOrderItems(order) {
            for (const item of order.items) {
                // Check if item has productId and if pharmacy owns it
                if (item.productId) {
                    const productRef = doc(db, COLLECTIONS.products, item.productId);
                    const productSnap = await getDoc(productRef);

                    if (productSnap.exists()) {
                        const product = productSnap.data();
                        if (product.pharmacyId === pharmacyId) {
                            return true; // Pharmacy owns at least one product in this order
                        }
                    }
                } else if (item.name) {
                    // Fallback: find product by name
                    const productsQuery = query(
                        collection(db, COLLECTIONS.products),
                        where('name', '==', item.name),
                        where('pharmacyId', '==', pharmacyId)
                    );
                    const productsSnap = await getDocs(productsQuery);
                    if (!productsSnap.empty) {
                        return true; // Pharmacy owns at least one product in this order
                    }
                }
            }
            return false; // Pharmacy doesn't own any products in this order
        }

        // Make test function globally available
        window.testPharmacyPermissions = testPharmacyPermissions;

        // Test function for pharmacy permissions
        async function testPharmacyPermissions() {
            console.log('🏥 TESTING PHARMACY PERMISSIONS');
            console.log('Pharmacy ID:', pharmacyId);

            try {
                // Test 1: Can we read our own products?
                console.log('📦 Testing product read permissions...');
                const productsQuery = query(collection(db, COLLECTIONS.products), where('pharmacyId', '==', pharmacyId));
                const productsSnap = await getDocs(productsQuery);
                console.log(`✅ Can read ${productsSnap.size} products`);

                // Test 2: Can we update our own products?
                if (!productsSnap.empty) {
                    const testProduct = productsSnap.docs[0];
                    const testProductRef = doc(db, COLLECTIONS.products, testProduct.id);
                    const originalStock = testProduct.data().stock;

                    console.log('📝 Testing product update permissions...');
                    await updateDoc(testProductRef, {
                        stock: originalStock,
                        updatedAt: Date.now()
                    });
                    console.log('✅ Can update products');
                }

                // Test 3: Can we read orders?
                console.log('📋 Testing order read permissions...');
                const ordersQuery = query(collection(db, COLLECTIONS.orders), limit(1));
                const ordersSnap = await getDocs(ordersQuery);
                console.log(`✅ Can read ${ordersSnap.size} orders`);

                // Test 4: Can we update orders?
                if (!ordersSnap.empty) {
                    const testOrder = ordersSnap.docs[0];
                    const testOrderRef = doc(db, COLLECTIONS.orders, testOrder.id);
                    const originalStage = testOrder.data().stage;

                    console.log('📝 Testing order update permissions...');
                    await updateDoc(testOrderRef, {
                        stage: originalStage,
                        updatedAt: Date.now()
                    });
                    console.log('✅ Can update orders');
                }

                console.log('🎉 ALL PHARMACY PERMISSIONS WORKING!');

            } catch (error) {
                console.error('❌ PERMISSION TEST FAILED:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);

                if (error.code === 'permission-denied') {
                    console.log('🔧 SOLUTION: Update Firebase security rules');
                    console.log('   Deploy the updated firestore.rules to Firebase Console');
                }
            }
            console.log('=====================================');
        };

        // Global functions for order management
        window.declineOrder = async (orderId) => {
            console.log('❌ Declining order:', orderId);

            if (!confirm('Are you sure you want to decline this order? This action cannot be undone.')) {
                return;
            }

            // Find the decline button and set loading state
            const declineButton = document.querySelector(`button[onclick="declineOrder('${orderId}')"]`);
            setButtonLoading(declineButton, true, 'Declining...');

            try {
                const orderRef = doc(db, COLLECTIONS.orders, orderId);
                await updateDoc(orderRef, {
                    stage: 'Declined',
                    declinedAt: new Date(),
                    declinedBy: pharmacyId,
                    updatedAt: Date.now()
                });

                console.log('✅ Order declined successfully');
                alert('Order has been declined.');
                // Orders will be updated automatically via real-time listener

            } catch (error) {
                console.error('❌ Error declining order:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                setButtonLoading(declineButton, false);
            }
        };

        window.confirmOrder = async (orderId) => {
            console.log('🛒 Starting order confirmation for:', orderId);

            // Find the confirm button and set loading state
            const confirmButton = document.querySelector(`button[onclick="confirmOrder('${orderId}')"]`);
            setButtonLoading(confirmButton, true, 'Confirming...');

            try {
            const orderRef = doc(db, COLLECTIONS.orders, orderId);
            const orderSnap = await getDoc(orderRef);

            if (orderSnap.exists()) {
                const order = orderSnap.data();

                // Check if pharmacy owns products in this order
                const ownsItems = await pharmacyOwnsOrderItems(order);
                if (!ownsItems) {
                    alert('You can only confirm orders that contain your products.');
                    console.warn('❌ Pharmacy does not own any products in this order');
                    return;
                }

                console.log('✅ Pharmacy owns products in this order, proceeding with confirmation');

                // Validate stock availability before confirming order
                console.log('🔍 Validating stock availability for all items...');
                const insufficientStockItems = [];

                for (const item of order.items) {
                    let productRef = null;
                    let productSnap = null;

                    // Try to find product by ID first, then by name as fallback
                    if (item.productId) {
                        productRef = doc(db, COLLECTIONS.products, item.productId);
                        productSnap = await getDoc(productRef);
                    } else if (item.name) {
                        const productsQuery = query(
                            collection(db, COLLECTIONS.products),
                            where('name', '==', item.name),
                            where('pharmacyId', '==', pharmacyId)
                        );
                        const productsSnap = await getDocs(productsQuery);
                        if (!productsSnap.empty) {
                            const productDoc = productsSnap.docs[0];
                            productRef = doc(db, COLLECTIONS.products, productDoc.id);
                            productSnap = await getDoc(productRef);
                        }
                    }

                    if (productSnap && productSnap.exists()) {
                        const product = productSnap.data();
                        const availableStock = product.stock || 0;

                        if (availableStock === 0) {
                            insufficientStockItems.push(`${product.name} - Out of stock`);
                        } else if (availableStock < item.quantity) {
                            insufficientStockItems.push(`${product.name} - Only ${availableStock} available, ordered ${item.quantity}`);
                        }
                    } else {
                        insufficientStockItems.push(`${item.name} - Product not found`);
                    }
                }

                // If any items have insufficient stock, block the order confirmation
                if (insufficientStockItems.length > 0) {
                    const errorMessage = '❌ Cannot confirm order due to insufficient stock:\n\n' +
                        insufficientStockItems.join('\n') +
                        '\n\nPlease restock these items before confirming the order.';
                    alert(errorMessage);
                    console.error('❌ Order confirmation blocked due to insufficient stock:', insufficientStockItems);
                    return;
                }

                console.log('✅ All items have sufficient stock, proceeding with confirmation');

                // Deduct stock for each item
                console.log('📦 Starting stock deduction for', order.items.length, 'items');
                for (const item of order.items) {
                    let productRef = null;
                    let productSnap = null;

                    console.log(`🔍 Processing item: ${item.name} (Qty: ${item.quantity})`);

                    // Try to find product by ID first, then by name as fallback
                    if (item.productId) {
                        console.log(`📍 Looking for product by ID: ${item.productId}`);
                        // If productId is available, use it directly
                        productRef = doc(db, COLLECTIONS.products, item.productId);
                        productSnap = await getDoc(productRef);
                    } else if (item.name) {
                        console.log(`📍 Looking for product by name: ${item.name}`);
                        // Fallback: find product by name (less reliable but better than nothing)
                        const productsQuery = query(
                            collection(db, COLLECTIONS.products),
                            where('name', '==', item.name),
                            where('pharmacyId', '==', pharmacyId)
                        );
                        const productsSnap = await getDocs(productsQuery);
                        if (!productsSnap.empty) {
                            const productDoc = productsSnap.docs[0];
                            productRef = doc(db, COLLECTIONS.products, productDoc.id);
                            productSnap = await getDoc(productRef);
                        }
                    }

                    if (productSnap && productSnap.exists()) {
                        const product = productSnap.data();
                        console.log(`✅ Found product: ${product.name} (Current stock: ${product.stock})`);
                        console.log(`🔍 Product pharmacyId: ${product.pharmacyId}`);
                        console.log(`🔍 Current pharmacy userId: ${pharmacyId}`);
                        console.log(`🔍 Do they match? ${product.pharmacyId === pharmacyId ? 'YES' : 'NO'}`);

                        const newStock = Math.max(0, product.stock - item.quantity); // Prevent negative stock
                        console.log(`🔄 Updating stock: ${product.stock} → ${newStock}`);
                        if (product.stock - item.quantity < 0) {
                            console.warn(`⚠️ Attempted to deduct ${item.quantity} from ${product.stock} stock for ${product.name}, set to 0`);
                        }

                        try {
                            await updateDoc(productRef, { stock: newStock, updatedAt: Date.now() });
                            console.log(`✅ Successfully updated stock for ${product.name}`);
                        } catch (stockError) {
                            console.error(`❌ Failed to update stock for ${product.name}:`, stockError);
                            throw stockError; // Re-throw to stop the process
                        }
                    } else {
                        console.warn(`⚠️ Could not find product for item: ${item.name} (ID: ${item.productId || 'N/A'})`);
                        // Continue with other items instead of failing completely
                    }
                }
                console.log('✅ Stock deduction completed');

                // Update order status
                console.log('📝 Updating order status to Confirmed');
                try {
                    await updateDoc(orderRef, {
                        stage: 'Confirmed',
                        paymentStatus: 'Confirmed',
                        confirmedAt: Date.now()
                    });
                    console.log('✅ Order status updated successfully');
                } catch (orderError) {
                    console.error('❌ Failed to update order status:', orderError);
                    throw orderError; // Re-throw to stop the process
                }

                // Credit payment to pharmacy wallet for COD orders
                if (order.cod || order.paymentMethod === 'COD') {
                    console.log('💰 Crediting COD payment to pharmacy wallet');
                    await creditCODToPharmacyWallet(order);
                }

                await loadProducts();
                console.log('🎉 Order confirmation completed successfully!');
                alert('Order confirmed and stock deducted successfully!');
                // Orders will be updated automatically via real-time listener
            }
            } catch (error) {
                console.error('❌ Error confirming order:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                setButtonLoading(confirmButton, false);
            }
        };

        // Function to get the next action text based on current stage
        function getNextActionText(currentStage) {
            const stageActions = {
                'Pending': 'Confirm Payment',
                'Confirmed': 'Mark as Shipped',
                'To Be Received': 'Mark as Delivered',
                'Delivered': null // No next action
            };
            return stageActions[currentStage] || null;
        }

        // Function to get color classes for order stages
        function getStageColor(stage) {
            const stageColors = {
                'Pending': 'text-yellow-600 bg-yellow-50',
                'Confirmed': 'text-blue-600 bg-blue-50',
                'To Be Received': 'text-purple-600 bg-purple-50',
                'Delivered': 'text-green-600 bg-green-50',
                'Declined': 'text-red-600 bg-red-50',
                'Cancelled': 'text-gray-600 bg-gray-50'
            };
            return stageColors[stage] || 'text-gray-600 bg-gray-50';
        }

        window.advanceOrder = async (orderId) => {
            // Find the advance button and set loading state
            const advanceButton = document.querySelector(`button[onclick="advanceOrder('${orderId}')"]`);
            setButtonLoading(advanceButton, true, 'Processing...');

            try {
            const orderRef = doc(db, COLLECTIONS.orders, orderId);
            const orderSnap = await getDoc(orderRef);

            if (orderSnap.exists()) {
                const order = orderSnap.data();
                const stages = ['Pending', 'Confirmed', 'To Be Received', 'Delivered'];
                const currentIndex = stages.indexOf(order.stage);
                const nextStage = stages[Math.min(currentIndex + 1, stages.length - 1)];

                await updateDoc(orderRef, {
                    stage: nextStage,
                    updatedAt: Date.now()
                });

                // Orders will be updated automatically via real-time listener
                }
            } catch (error) {
                console.error('❌ Error advancing order:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                setButtonLoading(advanceButton, false);
            }
        };

        // Test function to manually update badges
        window.testBadges = async () => {
            console.log('Testing pharmacy badges...');
            await updateOrderCounts();

            // Force show a badge for testing
            const testBadge = document.querySelector('.pharmacy-order-count-badge');
            if (testBadge) {
                testBadge.textContent = '99';
                testBadge.style.display = 'inline-flex';
                console.log('Forced badge to show with count 99');
            }
        };

        window.viewOrderDetails = async (orderId) => {
            const orderRef = doc(db, COLLECTIONS.orders, orderId);
            const orderSnap = await getDoc(orderRef);

            if (orderSnap.exists()) {
                const order = orderSnap.data();

                // Handle Firestore Timestamp objects properly
                const orderDate = safeDateConversion(order.createdAt).toLocaleString();

                // Handle new customer info structure
                const customerName = order.customerInfo ? order.customerInfo.name : (order.userName || 'Unknown');
                const customerPhone = order.customerInfo ? order.customerInfo.phone : 'Not provided';
                const customerEmail = order.customerInfo ? order.customerInfo.email : 'Not provided';

                const detailsHTML = `
                    <div class="space-y-8">
                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Order Information Card -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-xl font-bold text-gray-900">Order Information</h4>
                                </div>
                    <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Order #</span>
                                        <span class="text-gray-900 font-mono">${orderId.slice(-6)}</span>
                            </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Status</span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStageColor(order.stage)}">
                                            ${order.stage}
                                        </span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Date</span>
                                        <span class="text-gray-900">${orderDate}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="font-medium text-gray-600">Total</span>
                                        <span class="text-gray-900 font-semibold">₱${order.total.toFixed(2)}</span>
                                    </div>
                            </div>
                        </div>

                            <!-- Customer Information Card -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                            </div>
                                    <h4 class="text-xl font-bold text-gray-900">Customer Information</h4>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Name</span>
                                        <span class="text-gray-900">${customerName}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Phone</span>
                                        <span class="text-gray-900">${customerPhone}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="font-medium text-gray-600">Email</span>
                                        <span class="text-gray-900">${customerEmail}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Payment Details Card -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-xl font-bold text-gray-900">Payment Details</h4>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Method</span>
                                        <span class="text-gray-900">${order.paymentMethod}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Status</span>
                                        <span class="text-gray-900">${order.paymentStatus}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="font-medium text-gray-600">COD</span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${order.cod ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-800'}">
                                            ${order.cod ? 'Yes' : 'No'}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Order Summary Card -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-xl font-bold text-gray-900">Order Summary</h4>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Items</span>
                                        <span class="text-gray-900 font-semibold">${order.items.length}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Total Amount</span>
                                        <span class="text-gray-900 font-semibold">₱${order.total.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="font-medium text-gray-600">Order Date</span>
                                        <span class="text-gray-900">${orderDate}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Items Ordered Section -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                </div>
                                <h4 class="text-xl font-bold text-gray-900">Items Ordered</h4>
                            </div>
                            <div class="bg-white rounded-lg p-4 space-y-3">
                                ${order.items.map(item => `
                                    <div class="flex justify-between items-center py-3 border-b border-gray-200 last:border-0">
                                        <div class="flex-1">
                                            <p class="font-medium text-gray-900">${item.name}</p>
                                            <p class="text-sm text-gray-600">₱${item.price} each</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-medium text-gray-900">Qty: ${item.quantity}</p>
                                            <p class="text-sm text-gray-600">₱${(item.price * item.quantity).toFixed(2)}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        ${order.deliveryAddress ? `
                        <!-- Delivery Address Section -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                </div>
                                <h4 class="text-xl font-bold text-gray-900">Delivery Address</h4>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <p class="text-gray-900">${order.deliveryAddress}</p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Create and show modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-emerald-500 to-blue-600 p-6 text-white">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold">Order Details</h3>
                                        <p class="text-emerald-100">#${orderId.slice(-6)}</p>
                                    </div>
                                </div>
                                <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-emerald-200 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                            ${detailsHTML}
                        </div>

                        <!-- Footer -->
                        <div class="bg-gray-50 px-6 py-4 flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };
            }
        };

        // Global functions for product management
        window.editProduct = async (productId) => {
            const productRef = doc(db, COLLECTIONS.products, productId);
            const productSnap = await getDoc(productRef);

            if (productSnap.exists()) {
                const product = productSnap.data();
                editingProductId = productId;

                // Populate form
                document.querySelector('input[name="name"]').value = product.name;
                document.querySelector('input[name="price"]').value = product.price;
                document.querySelector('input[name="stock"]').value = product.stock;
                document.querySelector('select[name="category"]').value = product.category || '';
                document.querySelector('input[name="imageURL"]').value = product.imageURL || '';
                document.querySelector('textarea[name="description"]').value = product.description || '';
                document.querySelector('input[name="featured"]').checked = product.featured || false;
                document.querySelector('input[name="prescription"]').checked = product.prescription || false;

                // Update UI
                const submitText = document.getElementById('submit-text');
                if (submitText) {
                    submitText.textContent = 'Update Product';
                }
                const cancelEdit = document.getElementById('cancel-edit');
                if (cancelEdit) {
                    cancelEdit.classList.remove('hidden');
                }
                document.querySelector('input[name="name"]').focus();
            }
        };

        window.deleteProduct = async (productId) => {
            if (confirm('Are you sure you want to delete this product?')) {
                await deleteDoc(doc(db, COLLECTIONS.products, productId));
                await loadProducts();
            }
        };

        // Cancel edit
        const cancelEditBtn = document.getElementById('cancel-edit');
        if (cancelEditBtn) {
            cancelEditBtn.onclick = () => {
                editingProductId = null;
                document.getElementById('product-form').reset();
                const submitText = document.getElementById('submit-text');
                if (submitText) {
                    submitText.textContent = 'Add Product';
                }
                cancelEditBtn.classList.add('hidden');
            };
        }

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Set loading state
            const isEditing = editingProductId !== null;
            setButtonLoading(submitBtn, true, isEditing ? 'Updating...' : 'Adding...');

            const productData = {
                name: data.name,
                price: Number(data.price || 0),
                discount: Number(data.discount || 0),
                stock: Number(data.stock || 0),
                category: data.category || 'Other',
                imageURL: data.imageURL || 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=800&auto=format&fit=crop',
                description: data.description || '',
                featured: Boolean(data.featured),
                prescription: Boolean(data.prescription),
                pharmacyId,
                disabled: false, // Products are enabled by default, manually managed
                updatedAt: Date.now()
            };

            try {
                if (editingProductId) {
                    await updateDoc(doc(db, COLLECTIONS.products, editingProductId), productData);
                } else {
                    productData.createdAt = Date.now();
                    await addDoc(collection(db, COLLECTIONS.products), productData);
                }

                document.getElementById('product-form').reset();
                editingProductId = null;
                const submitText = document.getElementById('submit-text');
                if (submitText) {
                    submitText.textContent = 'Add Product';
                }
                const cancelEdit = document.getElementById('cancel-edit');
                if (cancelEdit) {
                    cancelEdit.classList.add('hidden');
                }
                await loadProducts();
            } catch (error) {
                console.error('Error saving product:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                setButtonLoading(submitBtn, false);
            }
        });

        // Order status tab event listeners
        document.getElementById('order-status-tabs').addEventListener('click', async (e) => {
            const tab = e.target.closest('.pharmacy-tab-button');
            if (tab) {
                const status = tab.id.replace('tab-', '');
                await loadOrders(status);
            }
        });

        document.getElementById('logout').addEventListener('click', logout);

        // Wallet functionality
        async function loadWalletData() {
            if (!pharmacyId) return;

            try {
                const pharmacyRef = doc(db, COLLECTIONS.pharmacies, pharmacyId);
                const pharmacySnap = await getDoc(pharmacyRef);

                if (pharmacySnap.exists()) {
                    const data = pharmacySnap.data();
                    const walletBalance = data.walletBalance || 0;
                    const pendingBalance = data.pendingBalance || 0;

                    document.getElementById('wallet-balance').textContent = formatCurrency(walletBalance);
                    document.getElementById('pending-balance').textContent = formatCurrency(pendingBalance);
                }

                // Load recent transactions
                await loadTransactions();
            } catch (error) {
                console.error('Error loading wallet data:', error);
            }
        }

        // Payment method selection handler
        function setupPaymentMethodHandlers() {
            const paymentMethods = document.querySelectorAll('input[name="payment-method"]');
            const digitalWalletDetails = document.getElementById('digital-wallet-details');
            const bankDetails = document.getElementById('bank-details');

            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    // Hide all detail sections
                    digitalWalletDetails.classList.add('hidden');
                    bankDetails.classList.add('hidden');

                    // Show relevant section based on selection
                    if (this.value === 'gcash' || this.value === 'maya') {
                        digitalWalletDetails.classList.remove('hidden');
                    } else if (this.value === 'bank') {
                        bankDetails.classList.remove('hidden');
                    }
                });
            });
        }

        async function loadTransactions() {
            if (!pharmacyId) return;

            try {
                const transactionsRef = query(
                    collection(db, 'transactions'),
                    where('pharmacyId', '==', pharmacyId),
                    orderBy('createdAt', 'desc'),
                    limit(10)
                );
                const transactionsSnap = await getDocs(transactionsRef);

                const transactionsList = document.getElementById('transactions-list');

                if (transactionsSnap.empty) {
                    transactionsList.innerHTML = '<p class="text-gray-500 text-center py-4">No transactions yet</p>';
                    return;
                }

                const transactions = transactionsSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                transactionsList.innerHTML = transactions.map(transaction => `
                    <div class="flex items-center justify-between p-3 border rounded-lg">
                        <div>
                            <p class="font-medium text-gray-900">${transaction.type === 'payment_credit' ? 'Payment Received' : 'Withdrawal'}</p>
                            <p class="text-sm text-gray-600">${safeDateConversion(transaction.createdAt).toLocaleDateString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-medium ${transaction.type === 'payment_credit' ? 'text-emerald-600' : 'text-red-600'}">
                                ${transaction.type === 'payment_credit' ? '+' : '-'}₱${transaction.amount.toFixed(2)}
                            </p>
                            <p class="text-xs text-gray-500">${transaction.status}</p>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        async function requestWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const selectedPaymentMethod = document.querySelector('input[name="payment-method"]:checked');

            if (!amount || amount < 100) {
                alert('Please enter a valid amount (minimum ₱100)');
                return;
            }

            if (!selectedPaymentMethod) {
                alert('Please select a payment method');
                return;
            }

            let accountDetails = {};
            const paymentMethod = selectedPaymentMethod.value;

            if (paymentMethod === 'gcash' || paymentMethod === 'maya') {
                const mobileNumber = document.getElementById('mobile-number').value.trim();
                const accountName = document.getElementById('account-name').value.trim();

                if (!mobileNumber || !accountName) {
                    alert('Please enter mobile number and account name for digital wallet');
                    return;
                }

                accountDetails = {
                    mobileNumber: mobileNumber,
                    accountName: accountName
                };
            } else if (paymentMethod === 'bank') {
                const bankName = document.getElementById('bank-name').value.trim();
                const accountNumber = document.getElementById('account-number').value.trim();
                const bankAccountName = document.getElementById('bank-account-name').value.trim();

                if (!bankName || !accountNumber || !bankAccountName) {
                    alert('Please enter all bank account details');
                    return;
                }

                accountDetails = {
                    bankName: bankName,
                    accountNumber: accountNumber,
                    accountName: bankAccountName
                };
            }

            // Set loading state
            const withdrawalBtn = document.getElementById('request-withdrawal');
            setButtonLoading(withdrawalBtn, true, 'Submitting...');

            try {
                console.log('=== WITHDRAWAL REQUEST DEBUG ===');
                console.log('Pharmacy ID:', pharmacyId);
                console.log('User UID:', auth.currentUser?.uid);
                console.log('Amount:', amount);
                console.log('Bank Name:', bankName);
                console.log('Account Number:', accountNumber);

                // Check if pharmacy has sufficient balance
                const pharmacyRef = doc(db, COLLECTIONS.pharmacies, pharmacyId);
                const pharmacySnap = await getDoc(pharmacyRef);

                if (!pharmacySnap.exists()) {
                    alert('Pharmacy not found');
                    return;
                }

                const currentBalance = pharmacySnap.data().walletBalance || 0;
                if (amount > currentBalance) {
                    alert('Insufficient balance');
                    return;
                }

                console.log('Creating withdrawal request...');
                // Create withdrawal request
                const withdrawalData = {
                    pharmacyId: pharmacyId,
                    amount: amount,
                    paymentMethod: paymentMethod,
                    accountDetails: accountDetails,
                    status: 'pending',
                    requestedAt: Date.now()
                };
                console.log('Withdrawal data:', withdrawalData);

                await addDoc(collection(db, 'withdrawalRequests'), withdrawalData);
                console.log('Withdrawal request created successfully');

                console.log('Updating pharmacy balance...');
                // Update pharmacy balance
                await updateDoc(pharmacyRef, {
                    walletBalance: currentBalance - amount,
                    pendingBalance: (pharmacySnap.data().pendingBalance || 0) + amount
                });
                console.log('Pharmacy balance updated successfully');

                alert('Withdrawal request submitted successfully');

                // Clear form
                document.getElementById('withdrawal-amount').value = '';
                
                // Clear payment method selection
                document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
                    radio.checked = false;
                });
                
                // Hide all detail sections
                document.getElementById('digital-wallet-details').classList.add('hidden');
                document.getElementById('bank-details').classList.add('hidden');
                
                // Clear all input fields
                document.getElementById('mobile-number').value = '';
                document.getElementById('account-name').value = '';
                document.getElementById('bank-name').value = '';
                document.getElementById('account-number').value = '';
                document.getElementById('bank-account-name').value = '';

                // Reload wallet data
                await loadWalletData();
            } catch (error) {
                console.error('Error requesting withdrawal:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                setButtonLoading(withdrawalBtn, false);
            }
        }

        // Credit COD payment to pharmacy wallet
        async function creditCODToPharmacyWallet(order) {
            try {
                // Calculate total amount for this pharmacy's items
                let totalAmount = 0;
                const pharmacyItems = [];

                for (const item of order.items) {
                    const productId = item.productId || item.id;
                    if (!productId) continue;

                    const productRef = doc(db, COLLECTIONS.products, productId);
                    const productSnap = await getDoc(productRef);

                    if (!productSnap.exists()) continue;

                    const product = productSnap.data();
                    if (product.pharmacyId === pharmacyId) {
                        pharmacyItems.push(item);
                        totalAmount += item.price * item.quantity;
                    }
                }

                if (totalAmount === 0) {
                    console.log('No items found for this pharmacy in the order');
                    return;
                }

                // Calculate commission (5% platform fee)
                const commission = totalAmount * 0.05;
                const pharmacyAmount = totalAmount - commission;

                // Update pharmacy wallet
                const pharmacyRef = doc(db, COLLECTIONS.pharmacies, pharmacyId);
                const pharmacySnap = await getDoc(pharmacyRef);

                if (pharmacySnap.exists()) {
                    const currentBalance = pharmacySnap.data().walletBalance || 0;
                    const currentPending = pharmacySnap.data().pendingBalance || 0;

                    // For COD payments: Add to Available balance (pharmacy confirmed the payment)
                    await updateDoc(pharmacyRef, {
                        walletBalance: currentBalance + pharmacyAmount,
                        pendingBalance: currentPending, // Don't add to pending for COD
                        updatedAt: Date.now()
                    });

                    console.log(`💰 Credited ₱${pharmacyAmount.toFixed(2)} to pharmacy wallet (Commission: ₱${commission.toFixed(2)})`);
                }

                // Record transaction
                await addDoc(collection(db, 'transactions'), {
                    orderId: order.id || 'unknown',
                    pharmacyId: pharmacyId,
                    amount: pharmacyAmount,
                    commission: commission,
                    type: 'cod_payment_credit',
                    status: 'completed',
                    createdAt: Date.now()
                });

            } catch (error) {
                console.error('Error crediting COD payment:', error);
                throw error;
            }
        }

        // Wallet event listeners
        document.getElementById('request-withdrawal').addEventListener('click', requestWithdrawal);

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = 'login.html'; return; }
            await ensurePharmacy(user);
            const pharmDoc = await getDoc(doc(db, COLLECTIONS.pharmacies, user.uid));
            if (!pharmDoc.exists() || pharmDoc.data().disabled) {
                window.location.href = 'disabled.html';
                return;
            }
            if (!pharmDoc.data().approved) {
                const banner = document.createElement('div');
                banner.className = 'mb-4 rounded-xl border bg-yellow-50 text-yellow-800 p-3';
                banner.textContent = 'Your pharmacy is pending approval. Please contact support.';
                document.querySelector('main').prepend(banner);
                document.querySelectorAll('#product-form input, #product-form button, #orders-list button').forEach(el => el.disabled = true);
                return;
            }
            await loadProducts();
            loadAllOrders();
        });
    </script>
</body>

</html>