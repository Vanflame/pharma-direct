<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Addresses ‚Äî PHARMA DIRECT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css" />
</head>

<body class="min-h-screen bg-gray-50">
    <header class="bg-white border-b">
        <div class="mx-auto container-max px-4 py-3 flex items-center justify-between">
            <a href="index.html" class="font-semibold">PHARMA DIRECT</a>
            <div class="relative">
                <button id="account-btn"
                    class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 hover:bg-gray-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span id="account-name" class="text-sm font-medium truncate max-w-24"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div id="account-menu" class="dropdown-panel hidden">
                    <div class="user-info">
                        <p class="user-email" id="account-email"></p>
                        <p class="user-role" id="account-role"></p>
                    </div>
                    <a href="user-dashboard.html" class="dropdown-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"></path>
                        </svg>
                        <span>Dashboard</span>
                    </a>
                    <a href="track.html" class="dropdown-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                            </path>
                        </svg>
                        <span>My Orders</span>
                    </a>
                    <button id="logout-btn" class="dropdown-item w-full text-left">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                            </path>
                        </svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="mx-auto container-max px-4 py-8">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="cart.html"
                class="inline-flex items-center gap-2 text-emerald-600 hover:text-emerald-700 font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Cart
            </a>
        </div>

        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-semibold">Manage Addresses</h1>
            <button id="add-address-btn" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700">
                Add New Address
            </button>
        </div>

        <!-- Address List -->
        <div id="addresses-list" class="space-y-4">
            <div class="text-gray-500">Loading addresses...</div>
        </div>

        <!-- Add/Edit Address Modal -->
        <div id="address-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold" id="modal-title">Add New Address</h3>
                            <button id="close-address-modal" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <form id="address-form" class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Province</label>
                                <select id="province"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    required>
                                    <option value="">Select Province</option>
                                    <option value="Metro Manila">Metro Manila</option>
                                    <option value="Cavite">Cavite</option>
                                    <option value="Laguna">Laguna</option>
                                    <option value="Batangas">Batangas</option>
                                    <option value="Rizal">Rizal</option>
                                    <option value="Quezon">Quezon</option>
                                    <option value="Bulacan">Bulacan</option>
                                    <option value="Pampanga">Pampanga</option>
                                    <option value="Tarlac">Tarlac</option>
                                    <option value="Nueva Ecija">Nueva Ecija</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City/Municipality</label>
                                <select id="city"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    required>
                                    <option value="">Select City/Municipality</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Barangay</label>
                                <input type="text" id="barangay"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    placeholder="Enter barangay" required>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Postal Code</label>
                                    <input type="text" id="postal-code"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                        placeholder="1234" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">House/Unit No.</label>
                                    <input type="text" id="house-number"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                        placeholder="123" required>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Street Address</label>
                                <input type="text" id="street"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    placeholder="Enter street name" required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Landmark/Notes
                                    (Optional)</label>
                                <textarea id="landmark"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    rows="3" placeholder="Near the church, beside the school, etc."></textarea>
                            </div>

                            <div class="flex items-center">
                                <input type="checkbox" id="default-address"
                                    class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <label for="default-address" class="ml-2 block text-sm text-gray-700">Set as default
                                    address</label>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" id="cancel-address"
                                class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                Cancel
                            </button>
                            <button type="submit"
                                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                                Save Address
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { firebaseConfig, COLLECTIONS } from './js/firebase.js';
        import { fetchUserRole, logout } from './js/auth.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const accountBtn = document.getElementById('account-btn');
        const accountMenu = document.getElementById('account-menu');
        const accountName = document.getElementById('account-name');
        const accountEmail = document.getElementById('account-email');
        const accountRole = document.getElementById('account-role');
        const logoutBtn = document.getElementById('logout-btn');
        const addressesList = document.getElementById('addresses-list');
        const addAddressBtn = document.getElementById('add-address-btn');
        const addressModal = document.getElementById('address-modal');
        const addressForm = document.getElementById('address-form');
        const modalTitle = document.getElementById('modal-title');
        const provinceSelect = document.getElementById('province');
        const citySelect = document.getElementById('city');

        let currentUserId = null;
        let editingAddressId = null;

        // Philippine cities by province
        const citiesByProvince = {
            'Metro Manila': ['Manila', 'Quezon City', 'Caloocan', 'Las Pi√±as', 'Makati', 'Malabon', 'Mandaluyong', 'Marikina', 'Muntinlupa', 'Navotas', 'Para√±aque', 'Pasay', 'Pasig', 'Pateros', 'San Juan', 'Taguig', 'Valenzuela'],
            'Cavite': ['Bacoor', 'Cavite City', 'Dasmari√±as', 'Imus', 'Kawit', 'Noveleta', 'Rosario', 'Silang', 'Tanza', 'Trece Martires City'],
            'Laguna': ['Bi√±an', 'Cabuyao', 'Calamba', 'San Pablo', 'Santa Rosa', 'Alaminos', 'Bay', 'Calauan', 'Cavinti', 'Famy', 'Kalayaan', 'Liliw', 'Los Ba√±os', 'Luisiana', 'Lumban', 'Mabitac', 'Magdalena', 'Majayjay', 'Nagcarlan', 'Paete', 'Pagsanjan', 'Pakil', 'Pangil', 'Pila', 'Rizal', 'San Pedro', 'Siniloan', 'Victoria'],
            'Batangas': ['Batangas City', 'Lipa', 'Tanauan', 'Bauan', 'Calaca', 'Calatagan', 'Cuenca', 'Ibaan', 'Laurel', 'Lemery', 'Lian', 'Lobo', 'Mabini', 'Malvar', 'Mataasnakahoy', 'Nasugbu', 'Padre Garcia', 'Rosario', 'San Jose', 'San Juan', 'San Luis', 'San Nicolas', 'Santo Tomas', 'Taal', 'Talisay', 'Taysan', 'Tingloy', 'Tuy'],
            'Rizal': ['Antipolo', 'Angono', 'Baras', 'Binangonan', 'Cainta', 'Cardona', 'Jalajala', 'Morong', 'Pililla', 'Rodriguez', 'San Mateo', 'Tanay', 'Taytay', 'Teresa'],
            'Quezon': ['Lucena', 'Tayabas', 'Alabat', 'Atimonan', 'Buenavista', 'Burdeos', 'Calauag', 'Candelaria', 'Catanauan', 'Dolores', 'General Luna', 'General Nakar', 'Guinayangan', 'Gumaca', 'Infanta', 'Jomalig', 'Lopez', 'Lucban', 'Macalelon', 'Mauban', 'Mulanay', 'Padre Burgos', 'Pagbilao', 'Panukulan', 'Patnanungan', 'Perez', 'Pitogo', 'Plaridel', 'Polillo', 'Quezon', 'Real', 'Sampaloc', 'San Andres', 'San Antonio', 'San Francisco', 'San Narciso', 'Sariaya', 'Tagkawayan', 'Tiaong', 'Unisan'],
            'Bulacan': ['Malolos', 'Meycauayan', 'San Jose del Monte', 'Baliuag', 'Bocaue', 'Calumpit', 'Do√±a Remedios Trinidad', 'Guiguinto', 'Hagonoy', 'Marilao', 'Norzagaray', 'Obando', 'Pandi', 'Paombong', 'Plaridel', 'Pulilan', 'San Ildefonso', 'San Miguel', 'San Rafael', 'Santa Maria'],
            'Pampanga': ['Angeles', 'San Fernando', 'Apalit', 'Arayat', 'Bacolor', 'Candaba', 'Floridablanca', 'Guagua', 'Lubao', 'Mabalacat', 'Macabebe', 'Magalang', 'Masantol', 'Mexico', 'Minalin', 'Porac', 'San Luis', 'San Simon', 'Santa Ana', 'Santa Rita', 'Santo Tomas', 'Sasmuan'],
            'Tarlac': ['Tarlac City', 'Anao', 'Bamban', 'Camiling', 'Capas', 'Concepcion', 'Gerona', 'La Paz', 'Mayantoc', 'Moncada', 'Paniqui', 'Pura', 'Ramos', 'San Clemente', 'San Jose', 'San Manuel', 'Santa Ignacia', 'Victoria'],
            'Nueva Ecija': ['Cabanatuan', 'Gapan', 'San Jose', 'Aliaga', 'Bongabon', 'Cabiao', 'Carranglan', 'Cuyapo', 'Gabaldon', 'General Mamerto Natividad', 'General Tinio', 'Guimba', 'Jaen', 'Laur', 'Llanera', 'Lupao', 'Mu√±oz', 'Nampicuan', 'Palayan', 'Pantabangan', 'Pe√±aranda', 'Quezon', 'Rizal', 'San Antonio', 'San Isidro', 'San Leonardo', 'Santa Rosa', 'Santo Domingo', 'Talavera', 'Talugtug', 'Zaragoza']
        };

        // Update cities when province changes
        provinceSelect.addEventListener('change', (e) => {
            const selectedProvince = e.target.value;
            citySelect.innerHTML = '<option value="">Select City/Municipality</option>';

            if (citiesByProvince[selectedProvince]) {
                citiesByProvince[selectedProvince].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        });

        async function loadAddresses() {
            if (!currentUserId) return;

            const addressesRef = query(collection(db, COLLECTIONS.addresses), where('userId', '==', currentUserId));
            const addressesSnap = await getDocs(addressesRef);

            if (addressesSnap.empty) {
                addressesList.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No addresses</h3>
                        <p class="mt-1 text-sm text-gray-500">Get started by adding a new address.</p>
                    </div>
                `;
                return;
            }

            // Count default addresses to handle multiple defaults
            let defaultAddressesCount = 0;
            addressesSnap.forEach(doc => {
                if (doc.data().isDefault) {
                    defaultAddressesCount++;
                }
            });

            console.log(`User has ${defaultAddressesCount} default addresses`);

            addressesList.innerHTML = addressesSnap.docs.map(doc => {
                const address = doc.data();
                const shouldShowAsDefault = address.isDefault && defaultAddressesCount <= 1;
                const shouldShowWarning = address.isDefault && defaultAddressesCount > 1;

                return `
                    <div class="bg-white rounded-lg border p-4 ${shouldShowAsDefault ? 'border-emerald-500 bg-emerald-50' : ''} ${shouldShowWarning ? 'border-yellow-500 bg-yellow-50' : ''}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <h3 class="font-medium text-gray-900">${address.houseNumber} ${address.street}</h3>
                                    ${shouldShowAsDefault ? '<span class="bg-emerald-100 text-emerald-800 text-xs px-2 py-1 rounded-full">Default</span>' : ''}
                                    ${shouldShowWarning ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">‚ö†Ô∏è Multiple Default</span>' : ''}
                                </div>
                                <p class="text-sm text-gray-600">${address.barangay}, ${address.city}, ${address.province} ${address.postalCode}</p>
                                ${address.landmark ? `<p class="text-sm text-gray-500 mt-1">Landmark: ${address.landmark}</p>` : ''}
                                ${shouldShowWarning ? '<p class="text-xs text-yellow-700 mt-2">‚ö†Ô∏è Multiple addresses are marked as default. Please set only one as default.</p>' : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="editAddress('${doc.id}')" class="text-blue-600 hover:text-blue-700 text-sm">Edit</button>
                                <button onclick="deleteAddress('${doc.id}')" class="text-red-600 hover:text-red-700 text-sm">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Show warning if there are multiple default addresses
            if (defaultAddressesCount > 1) {
                console.warn(`‚ö†Ô∏è User has ${defaultAddressesCount} default addresses. This violates the business rule of having only one default address per user.`);
            }
        }

        // Test function for debugging Firebase permissions
        window.testFirebaseConnection = async () => {
            console.log('=== FIREBASE CONNECTION TEST ===');
            try {
                // Test 1: Check authentication
                const user = auth.currentUser;
                console.log('User authenticated:', user ? 'YES' : 'NO');
                if (user) {
                    console.log('User UID:', user.uid);
                    console.log('User email:', user.email);
                } else {
                    console.log('‚ùå No user authenticated - please log in first');
                    return;
                }

                // Test 2: Try to read addresses collection
                console.log('Testing read permissions...');
                const testQuery = query(collection(db, COLLECTIONS.addresses), where('userId', '==', currentUserId));
                const testSnap = await getDocs(testQuery);
                console.log('‚úÖ Read test successful, found', testSnap.size, 'addresses');

                // Test 3: Try to write a test document
                console.log('Testing write permissions...');
                const testData = {
                    userId: currentUserId,
                    testField: 'This is a test document',
                    province: 'Test Province',
                    city: 'Test City',
                    barangay: 'Test Barangay',
                    postalCode: '1234',
                    street: 'Test Street',
                    timestamp: Date.now()
                };

                const testDocRef = doc(db, COLLECTIONS.addresses, `test_${Date.now()}`);
                await setDoc(testDocRef, testData);
                console.log('‚úÖ Write test successful! Document created');

                // Clean up test document
                await deleteDoc(testDocRef);
                console.log('‚úÖ Test cleanup successful - document deleted');

                console.log('üéâ ALL TESTS PASSED - Firebase connection and permissions are working!');

            } catch (error) {
                console.error('‚ùå TEST FAILED:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);

                // Provide specific guidance based on error
                if (error.code === 'permission-denied') {
                    console.log('üîß SOLUTION: Your Firebase security rules need to be updated.');
                    console.log('   Go to Firebase Console ‚Üí Firestore ‚Üí Rules and replace with the rules from firestore.rules');
                } else if (error.code === 'unavailable') {
                    console.log('üîß SOLUTION: Check your internet connection');
                } else {
                    console.log('üîß SOLUTION: Unknown error - check your Firebase configuration');
                }
            }
            console.log('================================');
        };

        // Function to clean up multiple default addresses (for data integrity)
        window.cleanupMultipleDefaults = async () => {
            if (!currentUserId) {
                console.error('No user ID available');
                return;
            }

            console.log('üßπ Starting cleanup of multiple default addresses...');

            try {
                // Find all default addresses for this user
                const defaultAddressesQuery = query(
                    collection(db, COLLECTIONS.addresses),
                    where('userId', '==', currentUserId),
                    where('isDefault', '==', true)
                );

                const defaultAddressesSnap = await getDocs(defaultAddressesQuery);

                if (defaultAddressesSnap.size <= 1) {
                    console.log('‚úÖ No cleanup needed - user has 1 or 0 default addresses');
                    return;
                }

                console.log(`Found ${defaultAddressesSnap.size} default addresses, cleaning up...`);

                // Keep the first one as default, unset others
                const docs = defaultAddressesSnap.docs;
                const keepDefaultDoc = docs[0]; // Keep the first one
                const unsetPromises = [];

                // Unset default flag from all addresses except the first one
                for (let i = 1; i < docs.length; i++) {
                    const addressRef = doc(db, COLLECTIONS.addresses, docs[i].id);
                    unsetPromises.push(
                        updateDoc(addressRef, {
                            isDefault: false,
                            updatedAt: Date.now()
                        })
                    );
                }

                await Promise.all(unsetPromises);

                console.log(`‚úÖ Cleanup complete! Kept default: ${keepDefaultDoc.id}, unset ${unsetPromises.length} others`);

                // Reload addresses to show updated state
                await loadAddresses();

            } catch (error) {
                console.error('‚ùå Error during cleanup:', error);
            }
        };

        // Global functions for address management
        window.editAddress = async (addressId) => {
            const addressRef = doc(db, COLLECTIONS.addresses, addressId);
            const addressSnap = await getDoc(addressRef);

            if (addressSnap.exists()) {
                const address = addressSnap.data();
                editingAddressId = addressId;
                modalTitle.textContent = 'Edit Address';

                // Populate form
                document.getElementById('province').value = address.province;
                document.getElementById('city').innerHTML = '<option value="">Select City/Municipality</option>';
                if (citiesByProvince[address.province]) {
                    citiesByProvince[address.province].forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        if (city === address.city) option.selected = true;
                        citySelect.appendChild(option);
                    });
                }
                document.getElementById('barangay').value = address.barangay;
                document.getElementById('postal-code').value = address.postalCode;
                document.getElementById('house-number').value = address.houseNumber;
                document.getElementById('street').value = address.street;
                document.getElementById('landmark').value = address.landmark || '';
                document.getElementById('default-address').checked = address.isDefault || false;

                addressModal.classList.remove('hidden');
            }
        };

        window.deleteAddress = async (addressId) => {
            if (confirm('Are you sure you want to delete this address?')) {
                await deleteDoc(doc(db, COLLECTIONS.addresses, addressId));
                await loadAddresses();
            }
        };

        // Form submission
        addressForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate user authentication
            if (!currentUserId) {
                alert('Please log in to save addresses.');
                return;
            }

            // DEBUG: Log authentication status
            console.log('=== DEBUG INFO ===');
            console.log('Current user authenticated:', auth.currentUser ? 'YES' : 'NO');
            console.log('Current user UID:', auth.currentUser?.uid);
            console.log('Current user ID from state:', currentUserId);
            console.log('===================');

            // Build form data - don't include createdAt when editing to preserve existing value
            const formData = {
                userId: currentUserId,
                province: document.getElementById('province').value,
                city: document.getElementById('city').value,
                barangay: document.getElementById('barangay').value,
                postalCode: document.getElementById('postal-code').value,
                houseNumber: document.getElementById('house-number').value,
                street: document.getElementById('street').value,
                landmark: document.getElementById('landmark').value,
                isDefault: document.getElementById('default-address').checked,
                updatedAt: Date.now()
            };

            // Only include createdAt for new addresses, not edits
            if (!editingAddressId) {
                formData.createdAt = Date.now();
            }

            try {
                // If this address is being set as default, unset default from other addresses
                if (formData.isDefault) {
                    console.log('Setting address as default, checking for existing default addresses...');

                    // Find all addresses for this user that are currently default
                    const defaultAddressesQuery = query(
                        collection(db, COLLECTIONS.addresses),
                        where('userId', '==', currentUserId),
                        where('isDefault', '==', true)
                    );

                    const defaultAddressesSnap = await getDocs(defaultAddressesQuery);

                    // Unset default flag from all other addresses
                    const unsetPromises = [];
                    defaultAddressesSnap.forEach(docSnap => {
                        // Don't unset the current address if we're editing it
                        if (editingAddressId && docSnap.id === editingAddressId) {
                            return;
                        }

                        const addressRef = doc(db, COLLECTIONS.addresses, docSnap.id);
                        unsetPromises.push(
                            updateDoc(addressRef, {
                                isDefault: false,
                                updatedAt: Date.now()
                            })
                        );
                    });

                    if (unsetPromises.length > 0) {
                        console.log(`Unsetting default flag from ${unsetPromises.length} other addresses...`);
                        await Promise.all(unsetPromises);
                        console.log('Successfully unset default flag from other addresses');
                    }
                }

                let result;
                let savedAddressId;

                if (editingAddressId) {
                    // For editing, use setDoc with merge to ensure proper permissions
                    result = await setDoc(doc(db, COLLECTIONS.addresses, editingAddressId), formData, { merge: true });
                    savedAddressId = editingAddressId;
                } else {
                    // For new addresses, try addDoc first, fallback to manual ID if needed
                    try {
                        result = await addDoc(collection(db, COLLECTIONS.addresses), formData);
                        savedAddressId = result.id;
                    } catch (permError) {
                        // If addDoc fails due to permissions, try with a manual document ID
                        if (permError.code === 'permission-denied') {
                            const manualId = `${currentUserId}_${Date.now()}`;
                            result = await setDoc(doc(db, COLLECTIONS.addresses, manualId), formData);
                            savedAddressId = manualId;
                        } else {
                            throw permError;
                        }
                    }
                }

                console.log('Address saved successfully with ID:', savedAddressId);

                addressModal.classList.add('hidden');
                addressForm.reset();
                editingAddressId = null;
                modalTitle.textContent = 'Add New Address';
                await loadAddresses();

                // Show success message
                showSuccessMessage('Address saved successfully!');

            } catch (error) {
                console.error('=== ADDRESS SAVE ERROR ===');
                console.error('Error details:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Current user ID:', currentUserId);
                console.error('Form data userId:', formData.userId);
                console.error('Is user authenticated?', auth.currentUser ? 'Yes' : 'No');
                console.error('Current user UID:', auth.currentUser?.uid);
                console.error('=======================');

                // Provide helpful error messages based on error type
                let errorMessage = 'Error saving address. ';
                if (error.code === 'permission-denied') {
                    errorMessage += 'Firebase permission denied. Please check your Firebase security rules.';
                } else if (error.code === 'unavailable') {
                    errorMessage += 'Network connection issue. Please try again.';
                } else if (error.code === 'cancelled') {
                    errorMessage += 'Operation was cancelled. Please try again.';
                } else {
                    errorMessage += `Unexpected error: ${error.code || 'Unknown'}`;
                }

                alert(errorMessage);
            }
        });

        // Helper function to show success messages
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Modal controls
        addAddressBtn.onclick = () => {
            editingAddressId = null;
            modalTitle.textContent = 'Add New Address';
            addressForm.reset();
            addressModal.classList.remove('hidden');
        };

        document.getElementById('close-address-modal').onclick = () => {
            addressModal.classList.add('hidden');
        };

        document.getElementById('cancel-address').onclick = () => {
            addressModal.classList.add('hidden');
        };

        addressModal.onclick = (e) => {
            if (e.target.id === 'address-modal') {
                addressModal.classList.add('hidden');
            }
        };

        onAuthStateChanged(auth, async (user) => {
            const uid = user?.uid || localStorage.getItem('uid');
            if (!uid) { window.location.href = 'login.html'; return; }

            const role = localStorage.getItem('role') || await fetchUserRole(uid);
            if (role !== 'user') {
                window.location.href = role === 'admin' ? 'admin.html' : 'pharmacy.html';
                return;
            }

            currentUserId = uid;

            // Update account info
            accountName.textContent = user?.displayName || 'Account';
            accountEmail.textContent = user?.email || '';
            accountRole.textContent = 'User';

            // Setup dropdown
            accountBtn.onclick = (e) => {
                e.stopPropagation();
                accountMenu.classList.toggle('hidden');
            };
            logoutBtn.onclick = async () => { await logout(); window.location.href = 'index.html'; };

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!accountBtn.closest('.relative').contains(e.target)) {
                    accountMenu.classList.add('hidden');
                }
            });

            // Load addresses
            await loadAddresses();
        });
    </script>
</body>

</html>