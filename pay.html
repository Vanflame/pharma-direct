<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment — PHARMA DIRECT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>

<body class="min-h-screen bg-gray-50">
    <header class="bg-white border-b">
        <div class="mx-auto container-max px-4 py-3 flex items-center justify-between">
            <a href="index.html" class="font-semibold text-emerald-600">PHARMA DIRECT</a>
            <div class="text-sm text-gray-600">Secure Payment</div>
        </div>
    </header>

    <main class="mx-auto container-max px-4 py-8 pb-24">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="track.html"
                class="inline-flex items-center gap-2 text-emerald-600 hover:text-emerald-700 font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Track Orders
            </a>
        </div>

        <div class="max-w-4xl mx-auto">
            <!-- Payment Header -->
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 rounded-2xl p-6 mb-6 text-white">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Complete Your Payment</h1>
                        <p class="text-emerald-100">Order ID: <span id="order-id"
                                class="font-mono text-emerald-200">Loading...</span></p>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        Order Summary
                    </h2>
                </div>
                <div class="p-6">
                    <div id="order-items" class="space-y-3 mb-4"></div>
                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Subtotal</span>
                            <span id="subtotal" class="font-medium">₱0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Delivery Fee</span>
                            <span id="delivery-fee" class="font-medium">₱0.00</span>
                        </div>
                        <div class="flex justify-between text-lg font-semibold border-t pt-2">
                            <span>Total</span>
                            <span id="grand-total" class="text-emerald-600">₱0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-blue-800 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                        Payment Method
                    </h2>
                </div>
                <div class="p-6">
                    <div id="payment-method" class="flex items-center gap-4 p-4 bg-blue-50 rounded-xl border border-blue-200"></div>
                </div>
            </div>

            <!-- QR Code Section -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-green-50 to-green-100 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-green-800 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                        </svg>
                        Payment QR Code
                    </h2>
                </div>
                <div class="p-6 text-center">
                    <div id="qr-code" class="inline-block p-4 bg-white border-2 border-gray-200 rounded-xl mb-4">
                        <div
                            class="w-48 h-48 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center">
                            <div class="text-center">
                                <p class="text-gray-600 text-sm">Loading QR Code...</p>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Scan this QR code with your mobile payment app</p>
                    <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">
                        <p class="font-mono break-all" id="payment-url">Loading payment URL...</p>
                    </div>
                </div>
            </div>

            <!-- Payment Actions -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 px-6 py-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Payment Actions
                    </h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <button id="pay-now-btn"
                            class="w-full bg-gradient-to-r from-emerald-600 to-emerald-700 text-white py-4 px-6 rounded-xl font-bold text-lg hover:from-emerald-700 hover:to-emerald-800 transition-all duration-300 disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="pay-btn-text">Pay Now</span>
                        </button>
                        <button id="cancel-payment"
                            class="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Cancel Payment
                        </button>
                    </div>
                    <div id="payment-feedback" class="mt-4 text-sm hidden"></div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { firebaseConfig, COLLECTIONS, formatCurrency } from './js/firebase.js';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentOrder = null;
        let currentOrderId = null;

        function getOrderIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('orderId');
        }

        async function loadOrderData(orderId) {
            try {
                const orderRef = doc(db, COLLECTIONS.orders, orderId);
                const orderSnap = await getDoc(orderRef);

                if (!orderSnap.exists()) {
                    showError('Order not found');
                    return;
                }

                currentOrder = orderSnap.data();
                currentOrderId = orderId;

                if (currentOrder.paymentStatus === 'Paid') {
                    showSuccess('Payment already completed');
                    return;
                }

                displayOrderData();
                generateQRCode();
                if (typeof QRCode === 'undefined') {
                    setTimeout(() => { generateQRCode(); }, 1000);
                }

            } catch (error) {
                console.error('Error loading order:', error);
                showError('Failed to load order data');
            }
        }

        function displayOrderData() {
            document.getElementById('order-id').textContent = currentOrderId.slice(-8);

            const itemsContainer = document.getElementById('order-items');
            itemsContainer.innerHTML = currentOrder.items.map(item => `
                <div class="flex items-center justify-between py-3 border-b border-gray-200 last:border-0">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 overflow-hidden">
                            ${item.imageURL ? 
                                `<img src="${item.imageURL}" alt="${item.name}" class="w-full h-full object-cover rounded-lg">` :
                                `<div class="w-full h-full bg-purple-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                </div>`
                            }
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-900 text-sm mb-1">${item.name}</h4>
                            <p class="text-xs text-gray-600">Qty: ${item.quantity}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-900">₱${(item.price * item.quantity).toFixed(2)}</p>
                        <p class="text-xs text-gray-600">₱${item.price} each</p>
                    </div>
                </div>
            `).join('');

            document.getElementById('subtotal').textContent = formatCurrency(currentOrder.total);
            document.getElementById('delivery-fee').textContent = formatCurrency(currentOrder.deliveryFee || 0);
            document.getElementById('grand-total').textContent = formatCurrency(currentOrder.grandTotal || currentOrder.total);

            const paymentMethodContainer = document.getElementById('payment-method');
            const methodIcons = { 
                'Card': '<svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>', 
                'GCash': '<svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>', 
                'PayMaya': '<svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>',
                'COD': '<svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>'
            };

            paymentMethodContainer.innerHTML = `
                <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center border border-blue-300">
                    ${methodIcons[currentOrder.paymentMethod] || methodIcons['Card']}
                </div>
                <div>
                    <p class="font-bold text-gray-900 text-lg">${currentOrder.paymentMethod}</p>
                    <p class="text-sm text-gray-600">Payment method selected</p>
                </div>
            `;
        }

        function generateQRCode() {
            const paymentUrl = `${window.location.origin}/pharma-direct/pay.html?orderId=${currentOrderId}`;
            document.getElementById('payment-url').textContent = paymentUrl;

            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = '';

            if (typeof QRCode === 'undefined') {
                qrContainer.innerHTML = `
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(paymentUrl)}&color=10b981&bgcolor=ffffff" 
                         alt="Payment QR Code" 
                         class="w-48 h-48 border rounded-lg" />
                `;
                return;
            }

            QRCode.toCanvas(qrContainer, paymentUrl, {
                width: 200,
                height: 200,
                color: { dark: '#10b981', light: '#ffffff' }
            }, function (error) {
                if (error) {
                    console.error('QR Code generation error:', error);
                }
            });
        }

        async function processPayment() {
            const payBtn = document.getElementById('pay-now-btn');
            const payBtnText = document.getElementById('pay-btn-text');

            payBtn.disabled = true;
            payBtnText.textContent = 'Processing...';

            try {
                // Step 1: Update order status
                console.log('Updating order status...');
                const orderRef = doc(db, COLLECTIONS.orders, currentOrderId);
                await updateDoc(orderRef, {
                    paymentStatus: 'Paid',
                    stage: 'Confirmed',
                    paidAt: new Date(),
                    updatedAt: Date.now()
                });
                console.log('Order status updated successfully');

                // Step 2: Credit pharmacy wallets (with error handling)
                try {
                    console.log('Crediting pharmacy wallets...');
                    await creditToPharmacyWallet(currentOrder);
                    console.log('Pharmacy wallets credited successfully');
                } catch (walletError) {
                    console.warn('Warning: Could not credit pharmacy wallets:', walletError);
                    // Continue with payment even if wallet crediting fails
                }

                showSuccess('Payment completed successfully!');

                setTimeout(() => { window.location.href = 'track.html'; }, 2000);

            } catch (error) {
                console.error('Payment processing error:', error);

                let errorMessage = 'Payment failed. Please try again.';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Please check Firestore rules.';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                showError(errorMessage);
                payBtn.disabled = false;
                payBtnText.textContent = 'Pay Now';
            }
        }

        async function creditToPharmacyWallet(order) {
            try {
                console.log('Starting pharmacy wallet crediting process...');
                const pharmacyItems = {};

                // Group items by pharmacy
                for (const item of order.items) {
                    const productId = item.productId || item.id;
                    if (!productId) {
                        console.warn('Item missing productId:', item);
                        continue;
                    }

                    try {
                        const productRef = doc(db, COLLECTIONS.products, productId);
                        const productSnap = await getDoc(productRef);
                        if (!productSnap.exists()) {
                            console.warn('Product not found:', productId);
                            continue;
                        }

                        const product = productSnap.data();
                        const pharmacyId = product.pharmacyId;

                        if (!pharmacyItems[pharmacyId]) {
                            pharmacyItems[pharmacyId] = { items: [], totalAmount: 0 };
                        }

                        pharmacyItems[pharmacyId].items.push({
                            productId: productId,
                            quantity: item.quantity,
                            price: item.price
                        });
                        pharmacyItems[pharmacyId].totalAmount += item.price * item.quantity;
                    } catch (productError) {
                        console.warn('Error processing product:', productId, productError);
                        continue;
                    }
                }

                console.log('Pharmacy items grouped:', pharmacyItems);

                // Process each pharmacy
                for (const [pharmacyId, pharmacyData] of Object.entries(pharmacyItems)) {
                    try {
                        console.log(`Processing pharmacy: ${pharmacyId}`);
                        const commission = pharmacyData.totalAmount * 0.05;
                        const pharmacyAmount = pharmacyData.totalAmount - commission;

                        // Update pharmacy wallet
                        const pharmacyRef = doc(db, COLLECTIONS.pharmacies, pharmacyId);
                        const pharmacySnap = await getDoc(pharmacyRef);

                        if (pharmacySnap.exists()) {
                            console.log(`Updating pharmacy wallet for ${pharmacyId}`);
                            const currentBalance = pharmacySnap.data().walletBalance || 0;
                            const currentPending = pharmacySnap.data().pendingBalance || 0;
                            const isQRPayment = currentOrder.paymentMethod !== 'cod';

                            await updateDoc(pharmacyRef, {
                                walletBalance: isQRPayment ? currentBalance + pharmacyAmount : currentBalance,
                                pendingBalance: isQRPayment ? currentPending : currentPending + pharmacyAmount,
                                updatedAt: Date.now()
                            });
                            console.log(`Pharmacy wallet updated for ${pharmacyId}`);
                        } else {
                            console.warn(`Pharmacy not found: ${pharmacyId}`);
                        }

                        // Create transaction record
                        console.log(`Creating transaction for ${pharmacyId}`);
                        await addDoc(collection(db, 'transactions'), {
                            orderId: currentOrderId,
                            pharmacyId: pharmacyId,
                            amount: pharmacyAmount,
                            commission: commission,
                            type: 'payment_credit',
                            status: 'completed',
                            createdAt: Date.now()
                        });
                        console.log(`Transaction created for ${pharmacyId}`);

                        // Update product stock
                        for (const item of pharmacyData.items) {
                            try {
                                const productRef = doc(db, COLLECTIONS.products, item.productId);
                                const productSnap = await getDoc(productRef);

                                if (productSnap.exists()) {
                                    const currentStock = productSnap.data().stock || 0;
                                    const newStock = Math.max(0, currentStock - item.quantity);

                                    await updateDoc(productRef, {
                                        stock: newStock,
                                        updatedAt: Date.now()
                                    });
                                    console.log(`Stock updated for product ${item.productId}: ${currentStock} -> ${newStock}`);
                                }
                            } catch (stockError) {
                                console.warn(`Error updating stock for product ${item.productId}:`, stockError);
                            }
                        }
                    } catch (pharmacyError) {
                        console.error(`Error processing pharmacy ${pharmacyId}:`, pharmacyError);
                        // Continue with other pharmacies even if one fails
                    }
                }

                console.log('Payment credited and stock reduced successfully');
            } catch (error) {
                console.error('Error crediting payment:', error);
                throw error;
            }
        }

        function showSuccess(message) {
            const feedback = document.getElementById('payment-feedback');
            feedback.className = 'mt-4 text-sm text-emerald-600 bg-emerald-50 border border-emerald-200 p-4 rounded-xl flex items-center gap-2';
            feedback.innerHTML = `
                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                ${message}
            `;
            feedback.classList.remove('hidden');
        }

        function showError(message) {
            const feedback = document.getElementById('payment-feedback');
            feedback.className = 'mt-4 text-sm text-red-600 bg-red-50 border border-red-200 p-4 rounded-xl flex items-center gap-2';
            feedback.innerHTML = `
                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                ${message}
            `;
            feedback.classList.remove('hidden');
        }

        document.getElementById('pay-now-btn').addEventListener('click', processPayment);
        document.getElementById('cancel-payment').addEventListener('click', () => {
            if (confirm('Are you sure you want to cancel this payment?')) {
                window.location.href = 'cart.html';
            }
        });

        // Init without auth
        (async () => {
            const orderId = getOrderIdFromUrl();
            if (!orderId) {
                showError('Invalid payment link');
                return;
            }
            await loadOrderData(orderId);
        })();
    </script>
</body>
</html>
