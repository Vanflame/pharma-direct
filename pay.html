<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment â€” PHARMA DIRECT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>

<body class="min-h-screen bg-gray-50">
    <header class="bg-white border-b">
        <div class="mx-auto container-max px-4 py-3 flex items-center justify-between">
            <a href="index.html" class="font-semibold text-emerald-600">PHARMA DIRECT</a>
            <div class="text-sm text-gray-600">Secure Payment</div>
        </div>
    </header>

    <main class="mx-auto container-max px-4 py-8">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="track.html"
                class="inline-flex items-center gap-2 text-emerald-600 hover:text-emerald-700 font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Track Orders
            </a>
        </div>

        <div class="max-w-2xl mx-auto">
            <!-- Payment Header -->
            <div class="bg-white rounded-xl border p-6 mb-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold text-gray-900">Complete Your Payment</h1>
                        <p class="text-sm text-gray-600">Order ID: <span id="order-id"
                                class="font-mono">Loading...</span></p>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="bg-white rounded-xl border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Order Summary</h2>
                <div id="order-items" class="space-y-3 mb-4"></div>
                <div class="border-t pt-4 space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Subtotal</span>
                        <span id="subtotal" class="font-medium">â‚±0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Delivery Fee</span>
                        <span id="delivery-fee" class="font-medium">â‚±0.00</span>
                    </div>
                    <div class="flex justify-between text-lg font-semibold border-t pt-2">
                        <span>Total</span>
                        <span id="grand-total" class="text-emerald-600">â‚±0.00</span>
                    </div>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="bg-white rounded-xl border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Method</h2>
                <div id="payment-method" class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg"></div>
            </div>

            <!-- QR Code Section -->
            <div class="bg-white rounded-xl border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment QR Code</h2>
                <div class="text-center">
                    <div id="qr-code" class="inline-block p-4 bg-white border-2 border-gray-200 rounded-lg mb-4">
                        <div
                            class="w-48 h-48 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center">
                            <div class="text-center">
                                <p class="text-gray-600 text-sm">Loading QR Code...</p>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Scan this QR code with your mobile payment app</p>
                    <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">
                        <p class="font-mono break-all" id="payment-url">Loading payment URL...</p>
                    </div>
                </div>
            </div>

            <!-- Payment Actions -->
            <div class="bg-white rounded-xl border p-6">
                <div class="space-y-4">
                    <button id="pay-now-btn"
                        class="w-full bg-emerald-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-emerald-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <span id="pay-btn-text">Pay Now</span>
                    </button>
                    <button id="cancel-payment"
                        class="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        Cancel Payment
                    </button>
                </div>
                <div id="payment-feedback" class="mt-4 text-sm hidden"></div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { firebaseConfig, COLLECTIONS, formatCurrency } from './js/firebase.js';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentOrder = null;
        let currentOrderId = null;

        function getOrderIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('orderId');
        }

        async function loadOrderData(orderId) {
            try {
                const orderRef = doc(db, COLLECTIONS.orders, orderId);
                const orderSnap = await getDoc(orderRef);

                if (!orderSnap.exists()) {
                    showError('Order not found');
                    return;
                }

                currentOrder = orderSnap.data();
                currentOrderId = orderId;

                if (currentOrder.paymentStatus === 'Paid') {
                    showSuccess('Payment already completed');
                    return;
                }

                displayOrderData();
                generateQRCode();
                if (typeof QRCode === 'undefined') {
                    setTimeout(() => { generateQRCode(); }, 1000);
                }

            } catch (error) {
                console.error('Error loading order:', error);
                showError('Failed to load order data');
            }
        }

        function displayOrderData() {
            document.getElementById('order-id').textContent = currentOrderId.slice(-8);

            const itemsContainer = document.getElementById('order-items');
            itemsContainer.innerHTML = currentOrder.items.map(item => `
                <div class="flex justify-between items-center py-2 border-b last:border-0">
                    <div>
                        <h4 class="font-medium text-gray-900">${item.name}</h4>
                        <p class="text-sm text-gray-600">Qty: ${item.quantity}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-medium">â‚±${(item.price * item.quantity).toFixed(2)}</p>
                        <p class="text-sm text-gray-600">â‚±${item.price} each</p>
                    </div>
                </div>
            `).join('');

            document.getElementById('subtotal').textContent = formatCurrency(currentOrder.total);
            document.getElementById('delivery-fee').textContent = formatCurrency(currentOrder.deliveryFee || 0);
            document.getElementById('grand-total').textContent = formatCurrency(currentOrder.grandTotal || currentOrder.total);

            const paymentMethodContainer = document.getElementById('payment-method');
            const methodIcons = { 'Card': 'ðŸ’³', 'GCash': 'ðŸ“±', 'PayMaya': 'ðŸ“±' };

            paymentMethodContainer.innerHTML = `
                <div class="text-2xl">${methodIcons[currentOrder.paymentMethod] || 'ðŸ’³'}</div>
                <div>
                    <p class="font-medium text-gray-900">${currentOrder.paymentMethod}</p>
                    <p class="text-sm text-gray-600">Payment simulation</p>
                </div>
            `;
        }

        function generateQRCode() {
            const paymentUrl = `${window.location.origin}/pharma-direct/pay.html?orderId=${currentOrderId}`;
            document.getElementById('payment-url').textContent = paymentUrl;

            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = '';

            if (typeof QRCode === 'undefined') {
                qrContainer.innerHTML = `
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(paymentUrl)}&color=10b981&bgcolor=ffffff" 
                         alt="Payment QR Code" 
                         class="w-48 h-48 border rounded-lg" />
                `;
                return;
            }

            QRCode.toCanvas(qrContainer, paymentUrl, {
                width: 200,
                height: 200,
                color: { dark: '#10b981', light: '#ffffff' }
            }, function (error) {
                if (error) {
                    console.error('QR Code generation error:', error);
                }
            });
        }

        async function processPayment() {
            const payBtn = document.getElementById('pay-now-btn');
            const payBtnText = document.getElementById('pay-btn-text');

            payBtn.disabled = true;
            payBtnText.textContent = 'Processing...';

            try {
                // Removed auth.currentUser check

                const orderRef = doc(db, COLLECTIONS.orders, currentOrderId);
                await updateDoc(orderRef, {
                    paymentStatus: 'Paid',
                    stage: 'Confirmed',
                    paidAt: new Date(),
                    updatedAt: Date.now()
                });

                await creditToPharmacyWallet(currentOrder);

                showSuccess('Payment completed successfully!');

                setTimeout(() => { window.location.href = 'track.html'; }, 2000);

            } catch (error) {
                console.error('Payment processing error:', error);

                let errorMessage = 'Payment failed. Please try again.';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied.';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                showError(errorMessage);
                payBtn.disabled = false;
                payBtnText.textContent = 'Pay Now';
            }
        }

        async function creditToPharmacyWallet(order) {
            try {
                const pharmacyItems = {};

                for (const item of order.items) {
                    const productId = item.productId || item.id;
                    if (!productId) continue;

                    const productRef = doc(db, COLLECTIONS.products, productId);
                    const productSnap = await getDoc(productRef);
                    if (!productSnap.exists()) continue;

                    const product = productSnap.data();
                    const pharmacyId = product.pharmacyId;

                    if (!pharmacyItems[pharmacyId]) {
                        pharmacyItems[pharmacyId] = { items: [], totalAmount: 0 };
                    }

                    pharmacyItems[pharmacyId].items.push({
                        productId: productId,
                        quantity: item.quantity,
                        price: item.price
                    });
                    pharmacyItems[pharmacyId].totalAmount += item.price * item.quantity;
                }

                for (const [pharmacyId, pharmacyData] of Object.entries(pharmacyItems)) {
                    const commission = pharmacyData.totalAmount * 0.05;
                    const pharmacyAmount = pharmacyData.totalAmount - commission;

                    const pharmacyRef = doc(db, COLLECTIONS.pharmacies, pharmacyId);
                    const pharmacySnap = await getDoc(pharmacyRef);

                    if (pharmacySnap.exists()) {
                        const currentBalance = pharmacySnap.data().walletBalance || 0;
                        const currentPending = pharmacySnap.data().pendingBalance || 0;
                        const isQRPayment = currentOrder.paymentMethod !== 'cod';

                        await updateDoc(pharmacyRef, {
                            walletBalance: isQRPayment ? currentBalance + pharmacyAmount : currentBalance,
                            pendingBalance: isQRPayment ? currentPending : currentPending + pharmacyAmount,
                            updatedAt: Date.now()
                        });
                    }

                    await addDoc(collection(db, 'transactions'), {
                        orderId: currentOrderId,
                        pharmacyId: pharmacyId,
                        amount: pharmacyAmount,
                        commission: commission,
                        type: 'payment_credit',
                        status: 'completed',
                        createdAt: Date.now()
                    });

                    for (const item of pharmacyData.items) {
                        const productRef = doc(db, COLLECTIONS.products, item.productId);
                        const productSnap = await getDoc(productRef);

                        if (productSnap.exists()) {
                            const currentStock = productSnap.data().stock || 0;
                            const newStock = Math.max(0, currentStock - item.quantity);

                            await updateDoc(productRef, {
                                stock: newStock,
                                updatedAt: Date.now()
                            });
                        }
                    }
                }

                console.log('Payment credited and stock reduced successfully');
            } catch (error) {
                console.error('Error crediting payment:', error);
                throw error;
            }
        }

        function showSuccess(message) {
            const feedback = document.getElementById('payment-feedback');
            feedback.className = 'mt-4 text-sm text-emerald-600 bg-emerald-50 p-3 rounded-lg';
            feedback.textContent = message;
            feedback.classList.remove('hidden');
        }

        function showError(message) {
            const feedback = document.getElementById('payment-feedback');
            feedback.className = 'mt-4 text-sm text-red-600 bg-red-50 p-3 rounded-lg';
            feedback.textContent = message;
            feedback.classList.remove('hidden');
        }

        document.getElementById('pay-now-btn').addEventListener('click', processPayment);
        document.getElementById('cancel-payment').addEventListener('click', () => {
            if (confirm('Are you sure you want to cancel this payment?')) {
                window.location.href = 'cart.html';
            }
        });

        // Init without auth
        (async () => {
            const orderId = getOrderIdFromUrl();
            if (!orderId) {
                showError('Invalid payment link');
                return;
            }
            await loadOrderData(orderId);
        })();
    </script>
</body>
</html>
