<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel â€” PHARMA DIRECT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css" />
</head>

<body class="min-h-screen bg-gray-50">
    <div class="grid md:grid-cols-[240px_1fr] min-h-screen">
        <aside class="bg-white border-r border-gray-200 shadow-sm">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-emerald-500 to-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Admin Panel</h1>
                        <p class="text-sm text-gray-500">Platform Management</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="p-4 space-y-2">
                <button data-tab="overview" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl bg-gradient-to-r from-emerald-500 to-blue-600 text-white shadow-sm transition-all duration-200 hover:shadow-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"></path>
                    </svg>
                    <span class="font-medium">Overview</span>
                </button>
                
                <button data-tab="users" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200 hover:shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                    <span class="font-medium">Users</span>
                </button>
                
                <button data-tab="pharmacies" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200 hover:shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <span class="font-medium">Pharmacies</span>
                </button>
                
                <button data-tab="orders" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200 hover:shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    <span class="font-medium">Orders</span>
                </button>
                
                <button data-tab="wallet" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200 hover:shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                    <span class="font-medium">Wallet Management</span>
                </button>
                
                <button data-tab="cod" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200 hover:shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="font-medium">COD Settings</span>
                </button>
            </nav>

            <!-- Logout Section -->
            <div class="p-4 border-t border-gray-200 mt-auto">
                <button id="logout" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl text-red-600 hover:bg-red-50 transition-all duration-200 hover:shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </aside>
        <main class="p-4">
            <div id="tab-overview" class="space-y-6">
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-xl p-6 text-white">
                    <h1 class="text-2xl font-bold mb-2">Admin Dashboard</h1>
                    <p class="text-emerald-100">Welcome back! Here's an overview of your platform's performance.</p>
            </div>
                
                <!-- Overview Cards -->
                <div id="overview-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>

                <!-- Main Content Grid -->
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Recent Activities -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
            </div>
                                <h3 class="text-xl font-bold text-gray-900">Recent Activities</h3>
                            </div>
                            <div id="recent-activities" class="space-y-4">
                                <!-- Activities will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions & System Status -->
                    <div class="space-y-6">
                        <!-- Quick Actions -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-gray-900">Quick Actions</h3>
                            </div>
                            <div class="space-y-3">
                                <button onclick="document.querySelector('[data-tab=\'users\']').click()" class="w-full flex items-center gap-3 p-3 text-left rounded-lg hover:bg-gray-50 transition-colors">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900">Manage Users</div>
                                        <div class="text-sm text-gray-600">View and manage customer accounts</div>
                                    </div>
                                </button>
                                
                                <button onclick="document.querySelector('[data-tab=\'pharmacies\']').click()" class="w-full flex items-center gap-3 p-3 text-left rounded-lg hover:bg-gray-50 transition-colors">
                                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900">Manage Pharmacies</div>
                                        <div class="text-sm text-gray-600">Approve and manage pharmacy accounts</div>
                                    </div>
                                </button>
                                
                                <button onclick="document.querySelector('[data-tab=\'orders\']').click()" class="w-full flex items-center gap-3 p-3 text-left rounded-lg hover:bg-gray-50 transition-colors">
                                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900">View Orders</div>
                                        <div class="text-sm text-gray-600">Monitor and manage all orders</div>
                                    </div>
                                </button>
                                
                                <button onclick="document.querySelector('[data-tab=\'wallet\']').click()" class="w-full flex items-center gap-3 p-3 text-left rounded-lg hover:bg-gray-50 transition-colors">
                                    <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900">Wallet Management</div>
                                        <div class="text-sm text-gray-600">Process withdrawal requests</div>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- System Status -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-gray-900">System Status</h3>
                            </div>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-600">Platform Status</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                        Online
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-600">Database</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                        Connected
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-600">Payment Gateway</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                        Active
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-600">Last Backup</span>
                                    <span class="text-sm text-gray-500">2 hours ago</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alerts & Notifications -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4.828 7l2.586 2.586a2 2 0 002.828 0L12 7H4.828zM4 12h16M4 16h16"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Alerts & Notifications</h3>
                    </div>
                    <div id="alerts-container" class="space-y-3">
                        <!-- Alerts will be loaded here -->
                    </div>
                </div>
            </div>
            <div id="tab-users" class="hidden space-y-6">
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-xl p-6 text-white">
                    <h2 class="text-2xl font-bold">User Management</h2>
                    <p class="text-emerald-100 mt-1">Manage customer accounts and settings</p>
                </div>
                <div id="users-list" class="space-y-4 p-6"></div>
            </div>
            <div id="tab-pharmacies" class="hidden space-y-6">
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-xl p-6 text-white">
                    <h2 class="text-2xl font-bold">Pharmacy Management</h2>
                    <p class="text-emerald-100 mt-1">Manage pharmacy accounts and approvals</p>
                </div>
                <div id="pharmacies-list" class="space-y-4 p-6"></div>
            </div>
            <div id="tab-orders" class="hidden">
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-xl p-6 text-white mb-6">
                    <h2 class="text-2xl font-bold">Order Management</h2>
                    <p class="text-emerald-100 mt-1">Manage and track all customer orders</p>
                </div>

                <!-- Order Status Tabs -->
                <div class="bg-white rounded-xl border mb-6">
                    <div class="border-b">
                        <nav class="flex" id="admin-order-status-tabs">
                            <button id="tab-all"
                                class="admin-tab-button active flex-1 py-4 px-6 text-center border-b-2 border-emerald-500 text-emerald-600 font-medium relative">
                                All Orders
                                <span
                                    class="admin-order-count-badge absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-pending"
                                class="admin-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative">
                                Pending
                                <span
                                    class="admin-order-count-badge absolute -top-2 -right-2 bg-yellow-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-confirmed"
                                class="admin-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative">
                                Confirmed
                                <span
                                    class="admin-order-count-badge absolute -top-2 -right-2 bg-blue-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-to-be-received"
                                class="admin-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative">
                                To Be Received
                                <span
                                    class="admin-order-count-badge absolute -top-2 -right-2 bg-purple-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-delivered"
                                class="admin-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative">
                                Delivered
                                <span
                                    class="admin-order-count-badge absolute -top-2 -right-2 bg-green-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-declined"
                                class="admin-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative">
                                Declined
                                <span
                                    class="admin-order-count-badge absolute -top-2 -right-2 bg-gray-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                                    style="display: none;">0</span>
                            </button>
                        </nav>
                    </div>
                </div>

                <div id="orders-list" class="bg-white rounded-xl border"></div>
            </div>

            <!-- Wallet Management Tab -->
            <div id="tab-wallet" class="hidden space-y-6">
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-xl p-6 text-white">
                    <h2 class="text-2xl font-bold">Wallet Management</h2>
                    <p class="text-emerald-100 mt-1">Manage pharmacy withdrawals and wallet balances</p>
                </div>

                <!-- Withdrawal Requests -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Pending Withdrawal Requests</h3>
                    </div>
                    <div id="withdrawal-requests-list" class="space-y-3">
                        <!-- Withdrawal requests will be loaded here -->
                    </div>
                </div>

                <!-- Pharmacy Wallet Balances -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Pharmacy Wallet Balances</h3>
                    </div>
                    <div id="pharmacy-wallets-list" class="space-y-3">
                        <!-- Pharmacy wallets will be loaded here -->
                    </div>
                </div>
            </div>

            <div id="tab-cod" class="hidden space-y-6">
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-xl p-6 text-white">
                    <h2 class="text-2xl font-bold">COD Settings</h2>
                    <p class="text-emerald-100 mt-1">Configure Cash on Delivery thresholds and limits</p>
                </div>
                <form id="cod-form" class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Successful Orders</label>
                            <input name="codMinOrders" type="number" min="0" class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                        placeholder="Min successful orders" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Total Spend (â‚±)</label>
                            <input name="codMinSpend" type="number" min="0" class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                        placeholder="Min total spend (PHP)" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Maximum COD Amount (â‚±)</label>
                            <input name="codMaxLimit" type="number" min="0" class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                        placeholder="Max COD amount (PHP)" />
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Save Settings
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, setDoc, getDoc, query, where, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { firebaseConfig, COLLECTIONS, safeDateConversion, formatDate, formatRelativeTime, showError, showSuccess, getProfessionalErrorMessage, setButtonLoading, showLoadingModal, hideLoadingModal } from './js/firebase.js';
        import { logout } from './js/auth.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const tabs = document.querySelectorAll('aside [data-tab]');
        const panels = {
            overview: document.getElementById('tab-overview'),
            users: document.getElementById('tab-users'),
            pharmacies: document.getElementById('tab-pharmacies'),
            orders: document.getElementById('tab-orders'),
            wallet: document.getElementById('tab-wallet'),
            cod: document.getElementById('tab-cod'),
        };

        async function ensureAdmin(user) {
            const snap = await getDoc(doc(db, COLLECTIONS.users, user.uid));
            if (!snap.exists() || snap.data().role !== 'admin') {
                window.location.href = 'index.html';
            }
        }

        function showOrderDetails(orderId, order) {
            // Remove existing modal if any
            const existingModal = document.getElementById('order-details-modal');
            if (existingModal) {
                existingModal.remove();
            }

            const customerName = order.customerInfo ? order.customerInfo.name : (order.userName || 'Unknown');
            const customerPhone = order.customerInfo ? order.customerInfo.phone : 'Not provided';
            const customerEmail = order.customerInfo ? order.customerInfo.email : 'Not provided';

            const items = order.items ? order.items.map(item =>
                `${item.name} x${item.quantity} - â‚±${(item.price * item.quantity).toFixed(2)}`
            ).join('<br>') : 'No items';

            const details = `
                <div id="order-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-emerald-500 to-blue-600 p-6 text-white">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold">Order Details</h3>
                                        <p class="text-emerald-100">#${orderId.slice(-6)}</p>
                                    </div>
                                </div>
                                <button id="close-order-modal" class="text-white hover:text-emerald-200 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                            <div class="grid lg:grid-cols-2 gap-8 mb-8">
                                <!-- Order Information Card -->
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <div class="flex items-center gap-3 mb-6">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <h4 class="text-xl font-bold text-gray-900">Order Information</h4>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                            <span class="font-medium text-gray-600">Status</span>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStageColor(order.stage)}">
                                                ${order.stage}
                                            </span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                            <span class="font-medium text-gray-600">Payment</span>
                                            <span class="text-gray-900">${order.paymentMethod} (${order.paymentStatus})</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                            <span class="font-medium text-gray-600">Total</span>
                                            <span class="text-gray-900 font-semibold">â‚±${order.total ? order.total.toLocaleString() : '0'}</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2">
                                            <span class="font-medium text-gray-600">Order Date</span>
                                            <span class="text-gray-900">${order.createdAt ? safeDateConversion(order.createdAt).toLocaleString() : 'Unknown'}</span>
                                        </div>
                                    </div>
                            </div>

                                <!-- Customer Information Card -->
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <div class="flex items-center gap-3 mb-6">
                                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                        </div>
                                        <h4 class="text-xl font-bold text-gray-900">Customer Information</h4>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                            <span class="font-medium text-gray-600">Name</span>
                                            <span class="text-gray-900">${customerName}</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                            <span class="font-medium text-gray-600">Phone</span>
                                            <span class="text-gray-900">${customerPhone}</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                            <span class="font-medium text-gray-600">Email</span>
                                            <span class="text-gray-900">${customerEmail}</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2">
                                            <span class="font-medium text-gray-600">User ID</span>
                                            <span class="text-gray-900 font-mono text-sm">${order.userId || 'Unknown'}</span>
                                        </div>
                                    </div>
                            </div>
                        </div>

                            <!-- Items Ordered Section -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-xl font-bold text-gray-900">Items Ordered</h4>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                ${items}
                            </div>
                        </div>

                        ${order.deliveryAddress ? `
                            <!-- Delivery Address Section -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-xl font-bold text-gray-900">Delivery Address</h4>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <p class="text-gray-900">${order.deliveryAddress}</p>
                            </div>
                        </div>
                        ` : ''}
                        </div>

                        <!-- Footer -->
                        <div class="bg-gray-50 px-6 py-4 flex justify-end">
                            <button id="close-order-modal-btn" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', details);
            
            // Add event listeners for modal close
            const modal = document.getElementById('order-details-modal');
            const closeBtn = document.getElementById('close-order-modal');
            const closeBtnFooter = document.getElementById('close-order-modal-btn');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    modal.remove();
                });
            }
            
            if (closeBtnFooter) {
                closeBtnFooter.addEventListener('click', () => {
                    modal.remove();
                });
            }
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function showUserDetails(userId, user) {
            // Get user's orders
            const ordersQuery = query(collection(db, COLLECTIONS.orders), where('userId', '==', userId));
            const ordersSnap = await getDocs(ordersQuery);
            const orders = Array.from(ordersSnap.docs);

            const totalOrders = orders.length;
            const completedOrders = orders.filter(o => o.data().stage === 'Delivered').length;
            const totalSpent = orders.reduce((sum, o) => sum + (o.data().total || 0), 0);

            const recentOrders = orders.slice(0, 5).map(o => {
                const data = o.data();
                return `
                    <div class="flex justify-between items-center py-2 border-b last:border-0">
                        <div>
                            <div class="font-medium">#${o.id.slice(-6)}</div>
                            <div class="text-sm text-gray-600">${data.stage} â€¢ â‚±${data.total?.toLocaleString() || '0'}</div>
                        </div>
                        <div class="text-sm text-gray-500">
                            ${data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown'}
                        </div>
                    </div>
                `;
            }).join('') || '<div class="text-gray-500">No orders yet</div>';

            const details = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-hidden">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-emerald-500 to-blue-600 p-6 text-white">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold">User Details</h3>
                                        <p class="text-emerald-100">${user.name || 'Unnamed User'}</p>
                                    </div>
                                </div>
                                <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-emerald-200 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                            <div class="grid lg:grid-cols-2 gap-8 mb-8">
                                <!-- User Information Card -->
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <div class="flex items-center gap-3 mb-6">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <h4 class="text-xl font-bold text-gray-900">User Information</h4>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                            <span class="font-medium text-gray-600">Name</span>
                                            <span class="text-gray-900">${user.name || 'Not provided'}</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                            <span class="font-medium text-gray-600">Email</span>
                                            <span class="text-gray-900">${user.email || 'Not provided'}</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                            <span class="font-medium text-gray-600">Role</span>
                                            <span class="text-gray-900 capitalize">${user.role || 'user'}</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                            <span class="font-medium text-gray-600">COD Status</span>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${user.codUnlocked ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${user.codUnlocked ? 'Enabled' : 'Disabled'}
                                            </span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                            <span class="font-medium text-gray-600">Account Status</span>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${user.disabled ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                                ${user.disabled ? 'Disabled' : 'Active'}
                                            </span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                            <span class="font-medium text-gray-600">User ID</span>
                                            <span class="text-gray-900 font-mono text-sm">${userId}</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2">
                                            <span class="font-medium text-gray-600">Joined</span>
                                            <span class="text-gray-900">${user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleString() : 'Unknown'}</span>
                                        </div>
                                </div>
                            </div>

                                <!-- Order Statistics Card -->
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <div class="flex items-center gap-3 mb-6">
                                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                            </svg>
                                </div>
                                        <h4 class="text-xl font-bold text-gray-900">Order Statistics</h4>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="text-center p-4 bg-white rounded-lg">
                                            <div class="text-2xl font-bold text-blue-600">${totalOrders}</div>
                                            <div class="text-sm text-gray-600">Total Orders</div>
                                        </div>
                                        <div class="text-center p-4 bg-white rounded-lg">
                                            <div class="text-2xl font-bold text-green-600">${completedOrders}</div>
                                            <div class="text-sm text-gray-600">Completed</div>
                                        </div>
                                        <div class="text-center p-4 bg-white rounded-lg">
                                            <div class="text-2xl font-bold text-purple-600">â‚±${totalSpent.toLocaleString()}</div>
                                            <div class="text-sm text-gray-600">Total Spent</div>
                                        </div>
                                        <div class="text-center p-4 bg-white rounded-lg">
                                            <div class="text-2xl font-bold text-orange-600">â‚±${totalOrders > 0 ? (totalSpent / totalOrders).toFixed(2) : '0'}</div>
                                            <div class="text-sm text-gray-600">Average Order</div>
                                        </div>
                                    </div>
                            </div>
                        </div>

                            <!-- Recent Orders Section -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-xl font-bold text-gray-900">Recent Orders</h4>
                                </div>
                                <div class="bg-white rounded-lg p-4 max-h-60 overflow-y-auto">
                                ${recentOrders}
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="bg-gray-50 px-6 py-4 flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', details);
        }

        async function showPharmacyProducts(pharmacyId, pharmacy) {
            // Get pharmacy's products
            const productsQuery = query(collection(db, COLLECTIONS.products), where('pharmacyId', '==', pharmacyId));
            const productsSnap = await getDocs(productsQuery);
            const products = Array.from(productsSnap.docs);

            const totalProducts = products.length;
            const activeProducts = products.filter(p => !p.data().disabled).length;
            const outOfStock = products.filter(p => (p.data().stock || 0) === 0).length;

            const productsList = products.map(p => {
                const data = p.data();
                const isOutOfStock = (data.stock || 0) === 0;
                const isDisabled = data.disabled;

                return `
                    <div class="flex items-center justify-between py-3 border-b last:border-0 ${isDisabled ? 'opacity-60' : ''}">
                        <div class="flex items-center gap-3">
                            <img src="${data.imageURL || 'https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?q=80&w=100&auto=format&fit=crop'}" class="w-12 h-12 rounded object-cover" alt="${data.name}">
                            <div>
                                <div class="font-medium ${isDisabled ? 'text-gray-500' : ''}">${data.name}</div>
                                <div class="text-sm text-gray-600">
                                    â‚±${data.price?.toLocaleString() || '0'} â€¢ Stock: ${data.stock || 0}
                                    ${isOutOfStock ? ' â€¢ <span class="text-red-500">Out of Stock</span>' : ''}
                                    ${isDisabled ? ' â€¢ <span class="text-orange-500">Disabled</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <button data-product-id="${p.id}" data-action="toggle-product-status" class="px-3 py-1 text-sm rounded border ${isDisabled ? 'bg-green-50 text-green-700 hover:bg-green-100' : 'bg-orange-50 text-orange-700 hover:bg-orange-100'}">
                            ${isDisabled ? 'Enable' : 'Disable'}
                        </button>
                    </div>
                `;
            }).join('') || '<div class="text-gray-500 text-center py-4">No products found</div>';

            const details = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-emerald-500 to-blue-600 p-6 text-white">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold">Products</h3>
                                        <p class="text-emerald-100">${pharmacy.name}</p>
                                    </div>
                                </div>
                                <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-emerald-200 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                            <!-- Summary Cards -->
                            <div class="grid md:grid-cols-3 gap-6 mb-8">
                                <div class="bg-blue-50 rounded-xl p-6 text-center">
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                        </svg>
                            </div>
                                    <div class="text-3xl font-bold text-blue-600">${totalProducts}</div>
                                    <div class="text-sm text-blue-600 font-medium">Total Products</div>
                            </div>
                                <div class="bg-green-50 rounded-xl p-6 text-center">
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="text-3xl font-bold text-green-600">${activeProducts}</div>
                                    <div class="text-sm text-green-600 font-medium">Active Products</div>
                                </div>
                                <div class="bg-red-50 rounded-xl p-6 text-center">
                                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                        </svg>
                                    </div>
                                    <div class="text-3xl font-bold text-red-600">${outOfStock}</div>
                                    <div class="text-sm text-red-600 font-medium">Out of Stock</div>
                            </div>
                        </div>

                            <!-- Product List Section -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-xl font-bold text-gray-900">Product List</h4>
                                </div>
                                <div class="bg-white rounded-lg p-4 max-h-96 overflow-y-auto" id="pharmacy-products-list">
                                ${productsList}
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="bg-gray-50 px-6 py-4 flex justify-between">
                            <div class="flex gap-3">
                                <button onclick="hideAllPharmacyProducts('${pharmacyId}')" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"></path>
                                    </svg>
                                    Disable All
                            </button>
                                <button onclick="showAllPharmacyProducts('${pharmacyId}')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Enable All
                            </button>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', details);

            // Add event listener for individual product toggles
            setTimeout(() => {
                const productsList = document.getElementById('pharmacy-products-list');
                if (productsList) {
                    productsList.addEventListener('click', async (e) => {
                        const btn = e.target.closest('button[data-product-id]');
                        if (!btn) return;

                        const productRef = doc(db, COLLECTIONS.products, btn.dataset.productId);
                        const productSnap = await getDoc(productRef);
                        const productData = productSnap.data();

                        if (btn.dataset.action === 'toggle-product-status') {
                            await updateDoc(productRef, {
                                disabled: !productData.disabled,
                                updatedAt: new Date()
                            });

                            // Refresh the modal
                            const modal = btn.closest('.fixed');
                            if (modal) {
                                modal.remove();
                                showPharmacyProducts(pharmacyId, pharmacy);
                            }
                        }
                    });
                }
            }, 100);
        }

        async function hidePharmacyProducts(pharmacyId) {
            const productsQuery = query(collection(db, COLLECTIONS.products), where('pharmacyId', '==', pharmacyId));
            const productsSnap = await getDocs(productsQuery);

            const updatePromises = productsSnap.docs.map(docSnap =>
                updateDoc(doc(db, COLLECTIONS.products, docSnap.id), {
                    disabled: true,
                    updatedAt: new Date()
                })
            );

            await Promise.all(updatePromises);
            alert('All products have been disabled.');
        }

        async function showAllPharmacyProducts(pharmacyId) {
            const productsQuery = query(collection(db, COLLECTIONS.products), where('pharmacyId', '==', pharmacyId));
            const productsSnap = await getDocs(productsQuery);

            const updatePromises = productsSnap.docs.map(docSnap =>
                updateDoc(doc(db, COLLECTIONS.products, docSnap.id), {
                    disabled: false,
                    updatedAt: new Date()
                })
            );

            await Promise.all(updatePromises);
            alert('All products have been enabled.');
        }

        // Make functions globally available for onclick handlers
        window.hideAllPharmacyProducts = hidePharmacyProducts;
        window.showAllPharmacyProducts = showAllPharmacyProducts;

        // Test function to manually update badges
        window.testAdminBadges = async () => {
            console.log('Testing admin badges...');
            await updateAdminOrderCounts();

            // Force show a badge for testing
            const testBadge = document.querySelector('.admin-order-count-badge');
            if (testBadge) {
                testBadge.textContent = '99';
                testBadge.style.display = 'inline-flex';
                console.log('Forced admin badge to show with count 99');
            }
        };

        async function loadOverview() {
            const [users, pharmacies, orders, products] = await Promise.all([
                getDocs(collection(db, COLLECTIONS.users)),
                getDocs(collection(db, COLLECTIONS.pharmacies)),
                getDocs(collection(db, COLLECTIONS.orders)),
                getDocs(collection(db, COLLECTIONS.products))
            ]);

            const usersWithRoleUser = Array.from(users.docs).filter(d => (d.data().role || 'user') === 'user').length;
            const activePharmacies = Array.from(pharmacies.docs).filter(d => d.data().approved && !d.data().disabled).length;

            // Only count revenue from delivered orders
            const deliveredOrders = Array.from(orders.docs).filter(d => d.data().stage === 'Delivered');
            const revenue = deliveredOrders.reduce((s, d) => s + (d.data().total || 0), 0);

            // Additional statistics
            const totalOrders = orders.size;
            const pendingOrders = Array.from(orders.docs).filter(d => d.data().stage === 'Pending').length;
            const activeProducts = Array.from(products.docs).filter(d => !d.data().disabled).length;
            const outOfStockProducts = Array.from(products.docs).filter(d => (d.data().stock || 0) === 0).length;

            const cards = [
                { 
                    label: 'Active Users', 
                    value: usersWithRoleUser, 
                    color: 'text-blue-600',
                    bgColor: 'bg-blue-50',
                    iconColor: 'text-blue-600',
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>`
                },
                { 
                    label: 'Active Pharmacies', 
                    value: activePharmacies, 
                    color: 'text-green-600',
                    bgColor: 'bg-green-50',
                    iconColor: 'text-green-600',
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>`
                },
                { 
                    label: 'Total Orders', 
                    value: totalOrders, 
                    color: 'text-purple-600',
                    bgColor: 'bg-purple-50',
                    iconColor: 'text-purple-600',
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>`
                },
                { 
                    label: 'Pending Orders', 
                    value: pendingOrders, 
                    color: 'text-orange-600',
                    bgColor: 'bg-orange-50',
                    iconColor: 'text-orange-600',
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`
                },
                { 
                    label: 'Revenue (Delivered)', 
                    value: 'â‚±' + revenue.toLocaleString(), 
                    color: 'text-emerald-600',
                    bgColor: 'bg-emerald-50',
                    iconColor: 'text-emerald-600',
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>`
                },
                { 
                    label: 'Active Products', 
                    value: activeProducts, 
                    color: 'text-indigo-600',
                    bgColor: 'bg-indigo-50',
                    iconColor: 'text-indigo-600',
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>`
                },
                { 
                    label: 'Out of Stock', 
                    value: outOfStockProducts, 
                    color: 'text-red-600',
                    bgColor: 'bg-red-50',
                    iconColor: 'text-red-600',
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>`
                },
                { 
                    label: 'Total Products', 
                    value: products.size, 
                    color: 'text-gray-600',
                    bgColor: 'bg-gray-50',
                    iconColor: 'text-gray-600',
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>`
                },
            ];

            const wrap = document.getElementById('overview-cards');
            wrap.innerHTML = cards.map(c => `
                <div class='bg-white rounded-xl p-6 border border-gray-200 hover:shadow-lg transition-shadow duration-200'>
                    <div class='flex items-center justify-between mb-4'>
                        <div class='p-3 ${c.bgColor} rounded-lg'>
                            <div class='${c.iconColor}'>
                                ${c.icon}
                            </div>
                        </div>
                        <div class='text-right'>
                            <div class='text-3xl font-bold ${c.color}'>${c.value}</div>
                        </div>
                    </div>
                    <div class='text-sm font-medium text-gray-600'>${c.label}</div>
                </div>
            `).join('');

            // Load additional overview data
            await loadRecentActivities();
            await loadAlerts();
        }

        async function loadRecentActivities() {
            try {
                // Get recent orders
                const ordersQuery = query(collection(db, COLLECTIONS.orders), orderBy('createdAt', 'desc'), limit(5));
                const ordersSnap = await getDocs(ordersQuery);
                
                // Get recent user registrations
                const usersQuery = query(collection(db, COLLECTIONS.users), orderBy('createdAt', 'desc'), limit(3));
                const usersSnap = await getDocs(usersQuery);
                
                // Get recent pharmacy registrations
                const pharmaciesQuery = query(collection(db, COLLECTIONS.pharmacies), orderBy('createdAt', 'desc'), limit(3));
                const pharmaciesSnap = await getDocs(pharmaciesQuery);

                const activities = [];

                // Add recent orders
                ordersSnap.docs.forEach(doc => {
                    const order = doc.data();
                    const customerName = order.customerInfo ? order.customerInfo.name : (order.userName || 'Unknown');
                    activities.push({
                        type: 'order',
                        title: `New order from ${customerName}`,
                        description: `Order #${doc.id.slice(-6)} - â‚±${order.total?.toFixed(2) || '0'}`,
                        time: order.createdAt,
                        icon: 'M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01',
                        color: 'text-blue-600',
                        bgColor: 'bg-blue-100'
                    });
                });

                // Add recent user registrations
                usersSnap.docs.forEach(doc => {
                    const user = doc.data();
                    if (user.role === 'user') {
                        activities.push({
                            type: 'user',
                            title: `New user registered`,
                            description: `${user.name || user.email || 'Unknown user'}`,
                            time: user.createdAt,
                            icon: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z',
                            color: 'text-green-600',
                            bgColor: 'bg-green-100'
                        });
                    }
                });

                // Add recent pharmacy registrations
                pharmaciesSnap.docs.forEach(doc => {
                    const pharmacy = doc.data();
                    activities.push({
                        type: 'pharmacy',
                        title: `New pharmacy registered`,
                        description: `${pharmacy.name || 'Unknown pharmacy'}`,
                        time: pharmacy.createdAt,
                        icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4',
                        color: 'text-purple-600',
                        bgColor: 'bg-purple-100'
                    });
                });

                // Sort by time and take the most recent 8
                activities.sort((a, b) => {
                    const timeA = a.time?.seconds || 0;
                    const timeB = b.time?.seconds || 0;
                    return timeB - timeA;
                });

                const recentActivities = activities.slice(0, 8);

                const container = document.getElementById('recent-activities');
                if (recentActivities.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No recent activities</h3>
                            <p class="mt-1 text-sm text-gray-500">Activities will appear here as they happen.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = recentActivities.map(activity => `
                        <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
                            <div class="w-8 h-8 ${activity.bgColor} rounded-full flex items-center justify-center flex-shrink-0">
                                <svg class="w-4 h-4 ${activity.color}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${activity.icon}"></path>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900">${activity.title}</p>
                                <p class="text-sm text-gray-600">${activity.description}</p>
                                <p class="text-xs text-gray-500 mt-1">${activity.time ? formatRelativeTime(activity.time) : 'Unknown time'}</p>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading recent activities:', error);
                document.getElementById('recent-activities').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-sm text-red-600">Error loading activities</p>
                    </div>
                `;
            }
        }

        async function loadAlerts() {
            try {
                const alerts = [];

                // Check for pending withdrawal requests
                const withdrawalQuery = query(collection(db, 'withdrawalRequests'), where('status', '==', 'pending'));
                const withdrawalSnap = await getDocs(withdrawalQuery);
                
                if (withdrawalSnap.size > 0) {
                    alerts.push({
                        type: 'warning',
                        title: 'Pending Withdrawal Requests',
                        description: `${withdrawalSnap.size} withdrawal request${withdrawalSnap.size > 1 ? 's' : ''} pending approval`,
                        action: 'View Wallet Management',
                        actionUrl: 'wallet'
                    });
                }

                // Check for pending pharmacy approvals
                const pendingPharmaciesQuery = query(collection(db, COLLECTIONS.pharmacies), where('approved', '==', false));
                const pendingPharmaciesSnap = await getDocs(pendingPharmaciesQuery);
                
                if (pendingPharmaciesSnap.size > 0) {
                    alerts.push({
                        type: 'info',
                        title: 'Pending Pharmacy Approvals',
                        description: `${pendingPharmaciesSnap.size} pharmacy${pendingPharmaciesSnap.size > 1 ? 'ies' : ''} waiting for approval`,
                        action: 'View Pharmacies',
                        actionUrl: 'pharmacies'
                    });
                }

                // Check for low stock products
                const lowStockQuery = query(collection(db, COLLECTIONS.products), where('stock', '<=', 5));
                const lowStockSnap = await getDocs(lowStockQuery);
                
                if (lowStockSnap.size > 0) {
                    alerts.push({
                        type: 'warning',
                        title: 'Low Stock Alert',
                        description: `${lowStockSnap.size} product${lowStockSnap.size > 1 ? 's' : ''} running low on stock`,
                        action: 'View Products',
                        actionUrl: 'pharmacies'
                    });
                }

                // Check for recent system issues (mock data)
                const systemAlerts = [
                    {
                        type: 'success',
                        title: 'System Health',
                        description: 'All systems operating normally',
                        action: null,
                        actionUrl: null
                    }
                ];

                const allAlerts = [...alerts, ...systemAlerts];

                const container = document.getElementById('alerts-container');
                if (allAlerts.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <p class="text-sm text-gray-500">No alerts at this time</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = allAlerts.map(alert => {
                        const alertColors = {
                            warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                            info: 'bg-blue-50 border-blue-200 text-blue-800',
                            success: 'bg-green-50 border-green-200 text-green-800',
                            error: 'bg-red-50 border-red-200 text-red-800'
                        };

                        const iconColors = {
                            warning: 'text-yellow-600',
                            info: 'text-blue-600',
                            success: 'text-green-600',
                            error: 'text-red-600'
                        };

                        return `
                            <div class="flex items-start gap-3 p-4 border rounded-lg ${alertColors[alert.type] || alertColors.info}">
                                <div class="w-5 h-5 ${iconColors[alert.type] || iconColors.info} flex-shrink-0 mt-0.5">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-sm font-medium">${alert.title}</h4>
                                    <p class="text-sm mt-1">${alert.description}</p>
                                    ${alert.action ? `
                                        <button onclick="document.querySelector('[data-tab=\'${alert.actionUrl}\']').click()" class="text-sm font-medium underline hover:no-underline mt-2">
                                            ${alert.action}
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
                document.getElementById('alerts-container').innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-sm text-red-600">Error loading alerts</p>
                    </div>
                `;
            }
        }

        async function loadUsers() {
            const snap = await getDocs(collection(db, COLLECTIONS.users));
            const el = document.getElementById('users-list');
            const currentUid = auth.currentUser ? auth.currentUser.uid : null;
            el.innerHTML = Array.from(snap.docs)
                .filter(d => {
                    const u = d.data();
                    return (u.role === 'user') && d.id !== currentUid;
                })
                .map(d => {
                    const u = d.data();
                    const codStatus = u.codUnlocked ? 'On' : 'Off';
                    const codColor = u.codUnlocked ? 'text-green-600 bg-green-50' : 'text-gray-600 bg-gray-50';
                    const accountStatus = u.disabled ? 'Disabled' : 'Active';
                    const accountColor = u.disabled ? 'text-red-600 bg-red-50' : 'text-green-600 bg-green-50';
                    
                    return `
                    <div class='bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow'>
                        <div class='flex items-start justify-between'>
                            <!-- User Info -->
                            <div class='flex-1'>
                                <div class='flex items-center gap-3 mb-2'>
                                    <div class='w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center'>
                                        <svg class='w-5 h-5 text-emerald-600' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z'></path>
                                        </svg>
                                    </div>
          <div>
                                        <h3 class='font-semibold text-gray-900 text-lg'>${u.name || 'Unnamed User'}</h3>
                                        <p class='text-gray-600 text-sm'>${u.email}</p>
          </div>
                                </div>
                                
                                <!-- Status Badges -->
                                <div class='flex flex-wrap gap-2 mt-3'>
                                    <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${codColor}'>
                                        <svg class='w-3 h-3 mr-1' fill='currentColor' viewBox='0 0 20 20'>
                                            <path d='M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z'></path>
                                            <path fill-rule='evenodd' d='M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z' clip-rule='evenodd'></path>
                                        </svg>
                                        COD: ${codStatus}
                                    </span>
                                    <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${accountColor}'>
                                        <svg class='w-3 h-3 mr-1' fill='currentColor' viewBox='0 0 20 20'>
                                            <path fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z' clip-rule='evenodd'></path>
                                        </svg>
                                        ${accountStatus}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class='flex flex-col gap-2 ml-4'>
                                <button data-uid='${d.id}' data-action='view-details' class='flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors'>
                                    <svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z'></path>
                                        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z'></path>
                                    </svg>
                                    View Details
                                </button>
                                <button data-uid='${d.id}' data-action='toggle-cod' class='flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors'>
                                    <svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4'></path>
                                    </svg>
                                    Toggle COD
                                </button>
                                <button data-uid='${d.id}' data-action='toggle-disabled' class='flex items-center gap-2 px-4 py-2 ${u.disabled ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-red-100 text-red-700 hover:bg-red-200'} rounded-lg text-sm font-medium transition-colors'>
                                    <svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                        ${u.disabled ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'}
                                    </svg>
                                    ${u.disabled ? 'Enable' : 'Disable'}
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('') || "<div class='text-center py-8 text-gray-500'><p>No standard users to display.</p></div>";
            // Remove existing event listeners to prevent duplicates
            el.removeEventListener('click', handleUserClick);
            
            // Add new event listener
            el.addEventListener('click', handleUserClick);
        }

        async function loadPharmacies() {
            const snap = await getDocs(collection(db, COLLECTIONS.pharmacies));
            const el = document.getElementById('pharmacies-list');
            el.innerHTML = Array.from(snap.docs).map(d => {
                const p = d.data();
                const approvalStatus = p.approved ? 'Approved' : 'Pending';
                const approvalColor = p.approved ? 'text-green-600 bg-green-50' : 'text-yellow-600 bg-yellow-50';
                const accountStatus = p.disabled ? 'Disabled' : 'Active';
                const accountColor = p.disabled ? 'text-red-600 bg-red-50' : 'text-green-600 bg-green-50';
                
                return `
                <div class='bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow'>
                    <div class='flex items-start justify-between'>
                        <!-- Pharmacy Info -->
                        <div class='flex-1'>
                            <div class='flex items-center gap-3 mb-2'>
                                <div class='w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center'>
                                    <svg class='w-5 h-5 text-blue-600' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4'></path>
                                    </svg>
                                </div>
          <div>
                                    <h3 class='font-semibold text-gray-900 text-lg'>${p.name || 'Unnamed Pharmacy'}</h3>
                                    <p class='text-gray-600 text-sm'>${p.email}</p>
          </div>
          </div>
                            
                            <!-- Status Badges -->
                            <div class='flex flex-wrap gap-2 mt-3'>
                                <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${approvalColor}'>
                                    <svg class='w-3 h-3 mr-1' fill='currentColor' viewBox='0 0 20 20'>
                                        <path fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z' clip-rule='evenodd'></path>
                                    </svg>
                                    ${approvalStatus}
                                </span>
                                <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${accountColor}'>
                                    <svg class='w-3 h-3 mr-1' fill='currentColor' viewBox='0 0 20 20'>
                                        <path fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z' clip-rule='evenodd'></path>
                                    </svg>
                                    ${accountStatus}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class='flex flex-col gap-2 ml-4'>
                            <button data-id='${d.id}' data-action='view-products' class='flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors'>
                                <svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                    <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10'></path>
                                </svg>
                                View Products
                            </button>
                            <button data-id='${d.id}' data-action='toggle-approve' class='flex items-center gap-2 px-4 py-2 ${p.approved ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'} rounded-lg text-sm font-medium transition-colors'>
                                <svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                    ${p.approved ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'}
                                </svg>
                                ${p.approved ? 'Revoke' : 'Approve'}
                            </button>
                            <button data-id='${d.id}' data-action='toggle-disabled' class='flex items-center gap-2 px-4 py-2 ${p.disabled ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-red-100 text-red-700 hover:bg-red-200'} rounded-lg text-sm font-medium transition-colors'>
                                <svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                    ${p.disabled ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'}
                                </svg>
                                ${p.disabled ? 'Enable' : 'Disable'}
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            // Remove existing event listeners to prevent duplicates
            el.removeEventListener('click', handlePharmacyClick);
            
            // Add new event listener
            el.addEventListener('click', handlePharmacyClick);
        }

        let currentAdminOrderStatus = 'all';
        let allAdminOrders = [];
        let adminOrderCounts = { all: 0, pending: 0, confirmed: 0, 'to-be-received': 0, delivered: 0, declined: 0 };

        function updateAdminOrderCounts() {
            // Reset counts
            adminOrderCounts = { all: 0, pending: 0, confirmed: 0, 'to-be-received': 0, delivered: 0, declined: 0 };

            // Count orders by status
            allAdminOrders.forEach(({ order }) => {
                const status = order.stage.toLowerCase().replace(/\s+/g, '-');
                if (status in adminOrderCounts) {
                    adminOrderCounts[status]++;
                }
                adminOrderCounts.all++;
            });

            // Update tab badges
            document.querySelectorAll('.admin-tab-button').forEach(tab => {
                const tabId = tab.id.replace('tab-', '');
                const badge = tab.querySelector('.admin-order-count-badge');

                if (badge) {
                    const count = adminOrderCounts[tabId] || 0;
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'inline-flex' : 'none';
                }
            });

            console.log('Admin order counts:', adminOrderCounts);
        }

        // Handle user click events
        async function handleUserClick(e) {
            const btn = e.target.closest('button[data-uid]');
            if (!btn) return;
            
            // Set loading state for toggle actions
            if (btn.dataset.action === 'toggle-cod' || btn.dataset.action === 'toggle-disabled') {
                setButtonLoading(btn, true, 'Updating...');
            }
            
            const ref = doc(db, COLLECTIONS.users, btn.dataset.uid);
            const s = await getDoc(ref);
            const data = s.data();
            
            try {
                if (btn.dataset.action === 'view-details') {
                    showUserDetails(btn.dataset.uid, data);
                } else if (btn.dataset.action === 'toggle-cod') {
                    await updateDoc(ref, { codUnlocked: !data.codUnlocked });
                } else if (btn.dataset.action === 'toggle-disabled') {
                    await updateDoc(ref, { disabled: !data.disabled });
                }
                loadUsers();
            } catch (error) {
                console.error('Error updating user:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                if (btn.dataset.action === 'toggle-cod' || btn.dataset.action === 'toggle-disabled') {
                    setButtonLoading(btn, false);
                }
            }
        }

        // Handle pharmacy click events
        async function handlePharmacyClick(e) {
            const btn = e.target.closest('button[data-id]');
            if (!btn) return;
            
            // Set loading state for toggle actions
            if (btn.dataset.action === 'toggle-approve' || btn.dataset.action === 'toggle-disabled') {
                setButtonLoading(btn, true, 'Updating...');
            }
            
            const ref = doc(db, COLLECTIONS.pharmacies, btn.dataset.id);
            const s = await getDoc(ref);
            const data = s.data();
            
            try {
                if (btn.dataset.action === 'view-products') {
                    showPharmacyProducts(btn.dataset.id, data);
                } else if (btn.dataset.action === 'toggle-approve') {
                    await updateDoc(ref, { approved: !data.approved });
                } else if (btn.dataset.action === 'toggle-disabled') {
                    const newDisabledStatus = !data.disabled;
                    await updateDoc(ref, { disabled: newDisabledStatus });

                    // When disabling a pharmacy, hide all their products
                    if (newDisabledStatus) {
                        await hidePharmacyProducts(btn.dataset.id);
                    }
                }
                loadPharmacies();
            } catch (error) {
                console.error('Error updating pharmacy:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                if (btn.dataset.action === 'toggle-approve' || btn.dataset.action === 'toggle-disabled') {
                    setButtonLoading(btn, false);
                }
            }
        }

        // Handle order click events
        async function handleOrderClick(e) {
            const btn = e.target.closest('button[data-id]');
            if (!btn) return;
            
            // Set loading state for order actions
            if (btn.dataset.action === 'confirm' || btn.dataset.action === 'advance') {
                setButtonLoading(btn, true, 'Processing...');
            }
            
            const ref = doc(db, COLLECTIONS.orders, btn.dataset.id);
            const s = await getDoc(ref);
            const o = s.data();
            
            try {
                if (btn.dataset.action === 'view-details') {
                    showOrderDetails(btn.dataset.id, o);
                } else if (btn.dataset.action === 'confirm') {
                    await updateDoc(ref, { paymentStatus: 'Confirmed', stage: 'Confirmed' });
                } else if (btn.dataset.action === 'advance') {
                    const stages = ['Pending', 'Confirmed', 'To Be Received', 'Delivered'];
                    const idx = Math.max(0, stages.indexOf(o.stage));
                    const next = stages[Math.min(idx + 1, stages.length - 1)];
                    await updateDoc(ref, { stage: next });
                }
                // Orders will be updated automatically via real-time listener
            } catch (error) {
                console.error('Error updating order:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                if (btn.dataset.action === 'confirm' || btn.dataset.action === 'advance') {
                    setButtonLoading(btn, false);
                }
            }
        }

        function renderFilteredAdminOrders() {
            const filteredOrders = currentAdminOrderStatus === 'all'
                ? allAdminOrders
                : allAdminOrders.filter(({ order }) => {
                    const stage = order.stage.toLowerCase().replace(/\s+/g, '-');
                    // Handle special case for declined tab (matches both 'declined' and 'cancelled')
                    if (currentAdminOrderStatus === 'declined') {
                        return stage === 'declined' || stage === 'cancelled';
                    }
                    return stage === currentAdminOrderStatus;
                });

            const el = document.getElementById('orders-list');
            el.innerHTML = '';

            if (filteredOrders.length === 0) {
                el.innerHTML = `
                    <div class="p-8 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No orders</h3>
                        <p class="mt-1 text-sm text-gray-500">Orders will appear here when customers place them.</p>
                    </div>
                `;
                return;
            }

            // Add proper spacing container
            el.className = 'space-y-4 p-6';

            el.innerHTML = filteredOrders.map(({ doc, order }) => {
                const o = order;
                const customerName = o.customerInfo ? o.customerInfo.name : (o.userName || 'Unknown');
                const orderDate = safeDateConversion(o.createdAt).toLocaleString();
                const items = o.items ? o.items.map(item => `${item.name} x${item.quantity}`).join(', ') : 'No items';
                
                return `
                    <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-shadow duration-200 mb-4">
                        <!-- Order Header -->
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                    </svg>
                                </div>
          <div>
                                    <h4 class="text-xl font-bold text-gray-900">Order #${doc.id.slice(-6)}</h4>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStageColor(o.stage)}">
                                        ${o.stage}
                                    </span>
          </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Order Date</div>
                                <div class="text-sm font-medium text-gray-900">${orderDate}</div>
                            </div>
                        </div>

                        <!-- Order Content -->
                        <div class="grid md:grid-cols-2 gap-6 mb-4">
                            <!-- Left Column: Items & Payment -->
                            <div class="space-y-4">
          <div>
                                    <h5 class="font-medium text-gray-900 mb-2">Items Ordered</h5>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <p class="text-sm text-gray-700">${items}</p>
          </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-blue-50 rounded-lg p-3">
                                        <p class="text-xs font-medium text-blue-600 uppercase tracking-wide">Total Amount</p>
                                        <p class="text-lg font-semibold text-blue-900">â‚±${o.total ? o.total.toFixed(2) : '0.00'}</p>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-3">
                                        <p class="text-xs font-medium text-green-600 uppercase tracking-wide">Payment</p>
                                        <p class="text-sm font-semibold text-green-900">${o.paymentMethod} (${o.paymentStatus})</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Customer Info -->
                            <div class="space-y-4">
                                <div>
                                    <h5 class="font-medium text-gray-900 mb-2">Customer Information</h5>
                                    <div class="bg-gray-50 rounded-lg p-3 space-y-1">
                                        <p class="text-sm"><span class="font-medium">Name:</span> ${customerName}</p>
                                        <p class="text-sm"><span class="font-medium">User ID:</span> ${o.userId || 'Unknown'}</p>
                                    </div>
                                </div>
                                
                                ${o.deliveryAddress ? `
                                <div>
                                    <h5 class="font-medium text-gray-900 mb-2">Delivery Address</h5>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <p class="text-sm text-gray-700">${o.deliveryAddress}</p>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-2 pt-4 border-t border-gray-200">
                            <button data-id='${doc.id}' data-action='view-details' class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                View Details
                            </button>
            ${o.stage === 'Pending' ? `
                                <button data-id='${doc.id}' data-action='confirm' class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-600 transition-colors flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Confirm Payment
                                </button>
            ` : ''}
            ${getNextActionText(o.stage) ? `
                                <button data-id='${doc.id}' data-action='advance' class="bg-purple-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-purple-600 transition-colors flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                    </svg>
                                    ${getNextActionText(o.stage)}
                                </button>
            ` : ''}
          </div>
                    </div>
                `;
            }).join('');

            // Remove existing event listeners to prevent duplicates
            el.removeEventListener('click', handleOrderClick);
            
            // Add new event listener
            el.addEventListener('click', handleOrderClick);
        }

        // Function to get the next action text based on current stage
        function getNextActionText(currentStage) {
            const stageActions = {
                'Pending': 'Confirm Payment',
                'Confirmed': 'Mark as Shipped',
                'To Be Received': 'Mark as Delivered',
                'Delivered': null // No next action
            };
            return stageActions[currentStage] || null;
        }

        // Function to get color classes for order stages
        function getStageColor(stage) {
            const stageColors = {
                'Pending': 'text-yellow-600 bg-yellow-50',
                'Confirmed': 'text-blue-600 bg-blue-50',
                'To Be Received': 'text-purple-600 bg-purple-50',
                'Delivered': 'text-green-600 bg-green-50',
                'Declined': 'text-red-600 bg-red-50',
                'Cancelled': 'text-gray-600 bg-gray-50'
            };
            return stageColors[stage] || 'text-gray-600 bg-gray-50';
        }

        function loadOrders(status = 'all') {
            currentAdminOrderStatus = status;

            // Update tab styling
            document.querySelectorAll('.admin-tab-button').forEach(tab => {
                if (tab.id === `tab-${status}`) {
                    tab.classList.add('active', 'border-emerald-500', 'text-emerald-600');
                    tab.classList.remove('border-transparent', 'text-gray-500');
                } else {
                    tab.classList.remove('active', 'border-emerald-500', 'text-emerald-600');
                    tab.classList.add('border-transparent', 'text-gray-500');
                }
            });

            // Render filtered orders (client-side filtering)
            renderFilteredAdminOrders();
        }

        // Load all orders and set up real-time updates
        function loadAllAdminOrders() {
            // Show initial loading state
            const el = document.getElementById('orders-list');
            el.innerHTML = `
                <div class="flex items-center justify-center p-12">
                    <div class="text-center">
                        <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-emerald-500 hover:bg-emerald-400 transition ease-in-out duration-150 cursor-not-allowed">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading orders...
                        </div>
                    </div>
                </div>
            `;

            const ordersQuery = query(collection(db, COLLECTIONS.orders), orderBy('createdAt', 'desc'));

            onSnapshot(ordersQuery, (snap) => {
                allAdminOrders = [];

                // Process all orders
                snap.docs.forEach(doc => {
                    const order = doc.data();
                    allAdminOrders.push({ doc, order });
                });

                // Update counts and render
                updateAdminOrderCounts();
                renderFilteredAdminOrders();
            });
        }

        async function loadCodSettings() {
            const ref = doc(db, COLLECTIONS.settings, 'global');
            const s = await getDoc(ref);
            const form = document.getElementById('cod-form');
            if (s.exists()) {
                const v = s.data();
                form.codMinOrders.value = v.codMinOrders ?? '';
                form.codMinSpend.value = v.codMinSpend ?? '';
                form.codMaxLimit.value = v.codMaxLimit ?? '';
            }
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(form).entries());
                await setDoc(ref, {
                    codMinOrders: Number(data.codMinOrders || 0),
                    codMinSpend: Number(data.codMinSpend || 0),
                    codMaxLimit: Number(data.codMaxLimit || 0)
                }, { merge: true });
            });
        }

        // Admin order status tab event listeners
        document.getElementById('admin-order-status-tabs').addEventListener('click', async (e) => {
            const tab = e.target.closest('.admin-tab-button');
            if (tab) {
                const status = tab.id.replace('tab-', '');
                await loadOrders(status);
            }
        });

        document.getElementById('logout').addEventListener('click', logout);

        // Wallet management functionality
        async function loadWithdrawalRequests() {
            try {
                const requestsRef = query(
                    collection(db, 'withdrawalRequests'),
                    where('status', '==', 'pending'),
                    orderBy('requestedAt', 'desc')
                );
                const requestsSnap = await getDocs(requestsRef);

                const requestsList = document.getElementById('withdrawal-requests-list');

                if (requestsSnap.empty) {
                    requestsList.innerHTML = '<p class="text-gray-500 text-center py-4">No pending withdrawal requests</p>';
                    return;
                }

                const requests = requestsSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                requestsList.innerHTML = requests.map(request => `
                    <div class="flex items-center justify-between p-4 border rounded-lg">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h4 class="font-medium text-gray-900">Pharmacy ID: ${request.pharmacyId.slice(-8)}</h4>
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Pending</span>
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><strong>Amount:</strong> â‚±${request.amount.toFixed(2)}</p>
                                <p><strong>Bank:</strong> ${request.bankName}</p>
                                <p><strong>Account:</strong> ${request.accountNumber}</p>
                                <p><strong>Requested:</strong> ${new Date(request.requestedAt).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="approveWithdrawal('${request.id}', '${request.pharmacyId}', ${request.amount})" 
                                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors">
                                Approve
                            </button>
                            <button onclick="rejectWithdrawal('${request.id}', '${request.pharmacyId}', ${request.amount})" 
                                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                Reject
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading withdrawal requests:', error);
            }
        }

        async function loadPharmacyWallets() {
            try {
                const pharmaciesRef = collection(db, COLLECTIONS.pharmacies);
                const pharmaciesSnap = await getDocs(pharmaciesRef);

                const walletsList = document.getElementById('pharmacy-wallets-list');

                if (pharmaciesSnap.empty) {
                    walletsList.innerHTML = '<p class="text-gray-500 text-center py-4">No pharmacies found</p>';
                    return;
                }

                const pharmacies = pharmaciesSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                walletsList.innerHTML = pharmacies.map(pharmacy => `
                    <div class="flex items-center justify-between p-4 border rounded-lg">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${pharmacy.name}</h4>
                            <p class="text-sm text-gray-600">${pharmacy.email}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-medium text-emerald-600">â‚±${(pharmacy.walletBalance || 0).toFixed(2)}</p>
                            <p class="text-sm text-gray-500">Available</p>
                        </div>
                        <div class="text-right ml-4">
                            <p class="font-medium text-blue-600">â‚±${(pharmacy.pendingBalance || 0).toFixed(2)}</p>
                            <p class="text-sm text-gray-500">Pending</p>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading pharmacy wallets:', error);
            }
        }

        async function approveWithdrawal(requestId, pharmacyId, amount) {
            if (!confirm(`Approve withdrawal of â‚±${amount.toFixed(2)}?`)) return;

            // Find the approve button and set loading state
            const approveButton = document.querySelector(`button[onclick="approveWithdrawal('${requestId}', '${pharmacyId}', ${amount})"]`);
            setButtonLoading(approveButton, true, 'Approving...');

            try {
                // Update withdrawal request status
                await updateDoc(doc(db, 'withdrawalRequests', requestId), {
                    status: 'approved',
                    approvedAt: Date.now()
                });

                // Update pharmacy balance
                const pharmacyRef = doc(db, COLLECTIONS.pharmacies, pharmacyId);
                const pharmacySnap = await getDoc(pharmacyRef);

                if (pharmacySnap.exists()) {
                    const currentPending = pharmacySnap.data().pendingBalance || 0;
                    await updateDoc(pharmacyRef, {
                        pendingBalance: Math.max(0, currentPending - amount)
                    });
                }

                alert('Withdrawal approved successfully');
                await loadWithdrawalRequests();
                await loadPharmacyWallets();
            } catch (error) {
                console.error('Error approving withdrawal:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                setButtonLoading(approveButton, false);
            }
        }

        async function rejectWithdrawal(requestId, pharmacyId, amount) {
            if (!confirm(`Reject withdrawal of â‚±${amount.toFixed(2)}?`)) return;

            // Find the reject button and set loading state
            const rejectButton = document.querySelector(`button[onclick="rejectWithdrawal('${requestId}', '${pharmacyId}', ${amount})"]`);
            setButtonLoading(rejectButton, true, 'Rejecting...');

            try {
                // Update withdrawal request status
                await updateDoc(doc(db, 'withdrawalRequests', requestId), {
                    status: 'rejected',
                    rejectedAt: Date.now()
                });

                // Return amount to pharmacy wallet
                const pharmacyRef = doc(db, COLLECTIONS.pharmacies, pharmacyId);
                const pharmacySnap = await getDoc(pharmacyRef);

                if (pharmacySnap.exists()) {
                    const currentWallet = pharmacySnap.data().walletBalance || 0;
                    const currentPending = pharmacySnap.data().pendingBalance || 0;

                    await updateDoc(pharmacyRef, {
                        walletBalance: currentWallet + amount,
                        pendingBalance: Math.max(0, currentPending - amount)
                    });
                }

                alert('Withdrawal rejected and amount returned to wallet');
                await loadWithdrawalRequests();
                await loadPharmacyWallets();
            } catch (error) {
                console.error('Error rejecting withdrawal:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                setButtonLoading(rejectButton, false);
            }
        }

        // Make functions global for onclick handlers
        window.approveWithdrawal = approveWithdrawal;
        window.rejectWithdrawal = rejectWithdrawal;

        // Update tab switching to load wallet data
        tabs.forEach(btn => btn.addEventListener('click', async () => {
            // Remove active styling from all tabs
            tabs.forEach(b => {
                b.classList.remove('bg-gradient-to-r', 'from-emerald-500', 'to-blue-600', 'text-white', 'shadow-sm');
                b.classList.add('text-gray-700');
            });
            
            // Add active styling to clicked tab
            btn.classList.remove('text-gray-700');
            btn.classList.add('bg-gradient-to-r', 'from-emerald-500', 'to-blue-600', 'text-white', 'shadow-sm');
            
            // Show/hide panels
            Object.values(panels).forEach(p => p.classList.add('hidden'));
            panels[btn.dataset.tab].classList.remove('hidden');

            // Load wallet data when wallet tab is selected
            if (btn.dataset.tab === 'wallet') {
                await Promise.all([loadWithdrawalRequests(), loadPharmacyWallets()]);
            }
        }));

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = 'login.html'; return; }
            await ensureAdmin(user);
            await Promise.all([loadOverview(), loadUsers(), loadPharmacies(), loadCodSettings()]);
            loadAllAdminOrders();
        });
    </script>
</body>

</html>